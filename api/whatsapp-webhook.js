// api/whatsapp-webhook.js
import OpenAI from "openai";
import { Redis } from "@upstash/redis";
import crypto from "crypto";

/* =========================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
   ========================= */
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});

/* =========================
   –ö–û–ù–°–¢–ê–ù–¢–´ / –ö–õ–Æ–ß–ò
   ========================= */
const HISTORY_LEN = 8;

// WhatsApp Cloud API
const META_WA_TOKEN = process.env.META_WA_TOKEN; // –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (System User)
const META_WA_PHONE_NUMBER_ID = process.env.META_WA_PHONE_NUMBER_ID; // –Ω–æ–º–µ—Ä WA (id)
const META_WA_VERIFY_TOKEN = process.env.META_WA_VERIFY_TOKEN; // —Ç–≤–æ–π ¬´—Å–µ–∫—Ä–µ—Ç¬ª –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–µ–±—Ö—É–∫–∞
const META_APP_SECRET = process.env.META_APP_SECRET || ""; // –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ X-Hub-Signature-256 (–æ–ø—Ü–∏–æ–Ω–∞–ª, –Ω–æ –ª—É—á—à–µ —É–∫–∞–∑–∞—Ç—å)

const LANG_KEY = (id) => `wa:lang:${id}`;
const BOOK_KEY = (id) => `wa:book:${id}`;
const CONTACT_KEY = (id) => `wa:contact:${id}`;
const LAST_OFFER_KEY = (id) => `wa:last_offer:${id}`; // { topic, ts }
const COMBINE_MULTI_TOPICS = true;

/* =========================
   –ë–õ–û–ö –£–°–õ–£–ì ‚Äî –í–°–¢–ê–í–¨ –°–í–û–ô –°–ü–ò–°–û–ö 
   ========================= */
const SERVICES_TEXT = `
- –ª–æ–≥–æ—Ç–∏–ø –∏ —Å—Ç–∏–ª—å:
-- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ –∏ —Ñ–∏—Ä–º–µ–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–µ–≥–æ –æ–±—Ä–∞–∑ –∫–æ–º–ø–∞–Ω–∏–∏:
--- –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –º–∏—Å—Å–∏–∏ –∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ç—Ä–µ–Ω–¥–∞–º–∏;
--- —Å–º—ã—Å–ª–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Å–∏—Ö–æ–ª–æ–≥–∏–µ–π —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏;
--- —É—á–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞.
- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞:
-- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥—É–º–∞–Ω–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤:
--- —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã —Å–∞–π—Ç–∞ —Å —É—á–µ—Ç–æ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è;
--- –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–∏–∫–∏ –≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–π –≤–æ—Ä–æ–Ω–∫–∏;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∑–∞–π–Ω–∞ —Å–∞–π—Ç–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ñ–∏—Ä–º–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π;
--- –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ —Å –ø–∞–Ω–µ–ª—å—é –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏;
--- CEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –≤ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞—Ö.
- —Ä–µ–∫–ª–∞–º–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ:
-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∫–ª–∞–º—ã –≤ 2–ì–ò–°, OLX, –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ Google –∏ —Ç–∞—Ä–≥–µ—Ç–∞ –≤ Instagram:
--- —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –≤ 2–ì–ò–°, –≤—ã–±–æ—Ä —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤;
--- —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ OLX, –≤—ã–±–æ—Ä —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ Google;
--- –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–º–µ–¥–∏–π–Ω–æ–π —Å–µ—Ç–∏ (—Ä–µ–∫–ª–∞–º–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö);
--- –∞–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±—é–¥–∂–µ—Ç–∞;
--- –¥–∏–∑–∞–π–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –º–∞–∫–µ—Ç–æ–≤;
--- –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã;
--- —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–æ–≤ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º;
--- –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–µ–∫–ª–∞–º—ã.
- SMM –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ:
-- –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—á–∫–∏ –≤ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º (—Ä–∞–±–æ—á–µ–π –∏–ª–∏ –ª–∏—á–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞):
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞;
--- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞ –Ω–∞ 1 –º–µ—Å—è—Ü –≤–ø–µ—Ä–µ–¥;
--- –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –≤ Instagram;
--- —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π PR-—Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∏;
--- —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–≤–∏–¥–µ–æ—Å—ä–µ–º–∫–∞ –∏ –¥–∏–∑–∞–π–Ω –º–∞–∫–µ—Ç–æ–≤);
--- —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–ø–æ—Å—Ç—ã, reels, stories);
--- –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.
- –æ—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂ / call-center:
--- –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–¥–µ–ª–∞ –ø—Ä–æ–¥–∞–∂, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è:
--- –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –≤ –∫–æ–º–ø–∞–Ω–∏–∏;
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ —Å–∞–º–æ–π –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π;
--- –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ö–æ–ª–æ–¥–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂;
--- –æ–±—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –Ω–∞–≤—ã–∫–∞–º —É–¥–µ—Ä–∂–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–ó–ü, –±–æ–Ω—É—Å—ã, KPI);
--- –æ–±—É—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤–µ–¥–µ–Ω–∏—é –ø—Ä–æ–¥–∞–∂ –≤ CRM-—Å–∏—Å—Ç–µ–º–µ;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∞–ø–æ–≤ –∏ –≤–æ—Ä–æ–Ω–æ–∫ –ø—Ä–æ–¥–∞–∂ –≤ CRM.
- CRM, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –ò–ò:
-- –ü–µ—Ä–µ–≤–æ–¥ –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã –≤ CRM –ë–∏—Ç—Ä–∏–∫—Å24 –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã:
--- —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ crm-—Å–∏—Å—Ç–µ–º–µ –ë–∏—Ç—Ä–∏–∫—Å24;
--- —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–º–ø–∞–Ω–∏–∏;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π;
--- –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SIP-—Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ –∑–∞–ø–∏—Å–∏;
--- –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ WhatsApp, Telegram, Instagram, OLX, —á–∞—Ç –Ω–∞ —Å–∞–π—Ç–µ, —Ñ–æ—Ä–º –∑–∞—è–≤–æ–∫ —Å —Å–∞–π—Ç–∞;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∞–ø–æ–≤ –∏ –≤–æ—Ä–æ–Ω–æ–∫ –ø—Ä–æ–¥–∞–∂, —Å–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö;
--- –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–∑–∞–¥–∞—á–∏, –¥–µ–ª–∞, —Å—Ä–æ–∫–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è);
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ–±—É—á–µ–Ω–∏–µ –ò–ò —á–∞—Ç-–±–æ—Ç–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤ 24/7;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–≤–æ–∑–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ–∫–ª–∞–º—ã.
- –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–¥–µ–∏:
-- –†–∞—Å–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π –∫–æ–º–ø–∞–Ω–∏–∏:
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–∏–ª—É—á—à–µ–≥–æ –ø–ª–∞–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞;
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ —É—á—Ç–µ–Ω—ã;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ —Ä—ã–Ω–∫–µ;
--- —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è –±—Ä–µ–Ω–¥–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
- –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑:
-- –ê–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞ —Å —É—á–µ—Ç–æ–º –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤:
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–æ—Å–∞;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–≤—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫;
--- –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ —Ü–µ–Ω;
--- –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥—ã.
- —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑:
-- –í—ã—è–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω—ã –∏–º–µ—é—â–µ–≥–æ—Å—è –±–∏–∑–Ω–µ—Å–∞:
--- —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–±—ã—Ç–∫–æ–≤;
--- –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –ø–æ–Ω—è—Ç–Ω–æ–π –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è —Ñ–æ—Ä–º–µ;
--- –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–π –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–µ–¥–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞.
- —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω:
-- –ü—Ä–æ–≥–Ω–æ–∑ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö:
--- –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥–æ–≤, —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –ø—Ä–∏–±—ã–ª–∏;
--- –ø—Ä–æ–≥–Ω–æ–∑ –¥–≤–∏–∂–µ–Ω–∏—è –¥–µ–Ω–µ–≥;
--- —Ä–∞—Å—á–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π;
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏;
--- –∞–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫ –≤–Ω–µ—à–Ω–∏–º –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Ñ–∞–∫—Ç–æ—Ä–∞–º.
- –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω:
-- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ü–∏—Ñ—Ä–∞—Ö —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∏ —Ä–∏—Å–∫–æ–≤:
--- –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞;
--- –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è;
--- –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å–∞;
--- –æ–±—ä–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏;
--- –∞–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤;
--- —Ä–∞—Å—á–µ—Ç —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏;
--- SWOT-–∞–Ω–∞–ª–∏–∑.
- –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞:
-- –ö—Ä–∞—Ç–∫–∏–π –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω –ø—Ä–æ–µ–∫—Ç–∞:
--- –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞;
--- –ø–ª–∞–Ω –æ—Å–≤–æ–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π;
--- —Ä–∞—Å—á–µ—Ç —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏;
--- –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞;
--- –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞;
--- –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –ø–ª–∞–Ω;
--- —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø—Ä–æ–≥–Ω–æ–∑;
--- SWOT-–∞–Ω–∞–ª–∏–∑.
- –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π:
-- –°–æ–¥–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞):
--- —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–∑–µ—Ä–∞ –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π;
--- –∑–∞–ø—É—Å–∫ —Ä–µ–∫–ª–∞–º—ã —Å—Ä–µ–¥–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤;
--- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –∫ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∞–º —Å –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º–∏;
--- –ø–æ–º–æ—â—å –≤ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏.
- —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è:
-- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–¥–µ–∏, –º–∏—Å—Å–∏–∏, —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –∫–æ–º–ø–∞–Ω–∏–∏:
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∏—Å—Å–∏–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞;
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ü–µ–ª–µ–π;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–æ–≤;
--- –ø–ª–∞–Ω –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏;
--- —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏;
--- –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π;
--- —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞;
--- –ø–ª–∞–Ω –∏ —Å—Ä–æ–∫–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è.
- –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Ä–∞–±–æ—Ç—ã:
-- –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è:
--- –û—Å–Ω–æ–≤–æ–ø–æ–ª–∞–≥–∞—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:
---- –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ;
---- —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è;
---- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á.
--- –¶–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –∫–æ–º–ø–∞–Ω–∏–∏:
---- –ª–æ–≥–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π;
---- –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è PR-–∞–∫—Ü–∏–π;
---- –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –≤—Å—Ç—Ä–µ—á –∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–π;
---- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏–º–∏–¥–∂–µ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏;
---- –∫–∞–¥—Ä–æ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞;
---- —Ü–µ–Ω–æ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞;
---- —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–Ω–µ–π–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤;
---- —Ç–µ—Ö–Ω–∏–∫–∞ —Ö–æ–ª–æ–¥–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂.
--- –ú–µ–¥–∏–∞-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±—é–¥–∂–µ—Ç:
---- –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π;
---- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ —Ü–µ–ª–µ–≤—ã—Ö –°–ú–ò;
---- –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –ø–ª–∞–Ω.
- –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã:
-- –ê–Ω–∞–ª–∏–∑, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
--- –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–∏—Ö –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤;
--- –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—Ç—ã –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π –∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤;
--- –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º CRM-—Å–∏—Å—Ç–µ–º—ã.
- —Ñ—Ä–∞–Ω—á–∞–π–∑–∏–Ω–≥:
-- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —É–ø–∞–∫–æ–≤–∫–∞ –≤–æ —Ñ—Ä–∞–Ω—à–∏–∑—É –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –∏–ª–∏ –Ω–æ–≤–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞:
--- —Å–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —Ñ—Ä–∞–Ω—à–∏–∑—ã;
--- –æ–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è —Ñ—Ä–∞–Ω—à–∏–∑—ã;
--- —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º–æ–¥–µ–ª—å –±–∏–∑–Ω–µ—Å–∞;
--- —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –∏ –¥–æ–≥–æ–≤–æ—Ä—ã;
--- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∞–π—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏;
--- –∑–∞–ø—É—Å–∫ —Ñ—Ä–∞–Ω—à–∏–∑—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π.
- –±—Ä–µ–Ω–¥–±—É–∫:
-- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∏—Ä–º–µ–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è:
--- —Å—Ö–µ–º–∞ –∏ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞;
--- –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ñ–∏—Ä–º–µ–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞ (–∑–Ω–∞–∫, –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —Å–ª–æ–≥–∞–Ω);
--- —Å—Ç–∏–ª—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–µ (–≤–∏–∑–∏—Ç–∫–∏, –±–ª–∞–Ω–∫–∏, –ø–∞–ø–∫–∏ –∏ —Ç.–¥.);
--- –Ω–∞—Ä—É–∂–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ (–≤—ã–≤–µ—Å–∫–∞, –±–∏–ª–±–æ—Ä–¥);
--- –ø–µ—á–∞—Ç–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ (—Ñ–ª–∞–µ—Ä, –±—É–∫–ª–µ—Ç, —Ä–µ–∫–ª–∞–º–Ω—ã–π –ø—Ä–æ—Å–ø–µ–∫—Ç);
--- –≤—ã—Å—Ç–∞–≤–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–Ω–∞–ø–æ–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä, –¥–∏–∑–∞–π–Ω —Å—Ç–µ–Ω–¥–∞);
--- –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –æ—Ñ–∏—Å–∞ (–¥–µ–∫–æ—Ä-—ç–ª–µ–º–µ–Ω—Ç—ã –≤ —Ñ–∏—Ä–º–µ–Ω–Ω–æ–º —Å—Ç–∏–ª–µ);
--- —Å—É–≤–µ–Ω–∏—Ä–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è (—Ä—É—á–∫–∏, –±–ª–æ–∫–Ω–æ—Ç—ã, –∫—Ä—É–∂–∫–∏, –∫–µ–ø–∫–∏, –ø–∞–∫–µ—Ç—ã).
`;

/* =========================
   –£–¢–ò–õ–ò–¢–´
   ========================= */
async function readBody(req) {
  return await new Promise((resolve, reject) => {
    let data = "";
    req.on("data", (chunk) => (data += chunk));
    req.on("end", () => resolve(data));
    req.on("error", reject);
  });
}
function safeParseItem(item) {
  if (item == null) return null;
  if (typeof item === "object") return item;
  if (typeof item === "string") {
    try { return JSON.parse(item); } catch { return null; }
  }
  return null;
}
async function getHistory(id) {
  const items = await redis.lrange(`hist:${id}`, -HISTORY_LEN, -1);
  return (items || []).map(safeParseItem).filter(Boolean);
}
async function pushHistory(id, role, content) {
  const entry = { role, content };
  await redis.rpush(`hist:${id}`, JSON.stringify(entry));
  await redis.ltrim(`hist:${id}`, -HISTORY_LEN, -1);
}

/* –°–ª–æ—Ç—ã –∑–∞—è–≤–∫–∏ (WA-–≤–µ—Ä—Å–∏—è): —Ç–æ–ª—å–∫–æ name, city, sphere + topic */
async function getBooking(id) {
  const val = await redis.get(BOOK_KEY(id));
  if (!val) return { stage: null, topic: null, name: null, city: null, sphere: null };
  if (typeof val === "object") return val;
  try { return JSON.parse(val); } catch {
    return { stage: null, topic: null, name: null, city: null, sphere: null };
  }
}
async function setBooking(id, data) {
  await redis.set(BOOK_KEY(id), JSON.stringify(data), { ex: 60 * 60 * 24 });
}
async function clearBooking(id) {
  await redis.del(BOOK_KEY(id));
}

/* –ö–æ–Ω—Ç–∞–∫—Ç (–∫—ç—à 30 –¥–Ω–µ–π) ‚Äî —Ö—Ä–∞–Ω–∏–º —Ö–æ—Ç—è –±—ã –∏–º—è –ø—Ä–æ—Ñ–∏–ª—è WA */
async function getContact(id) {
  const v = await redis.get(CONTACT_KEY(id));
  if (!v) return null;
  try { return typeof v === "string" ? JSON.parse(v) : v; } catch { return null; }
}
async function setContact(id, { name }) {
  await redis.set(CONTACT_KEY(id), JSON.stringify({ name: name || null }), { ex: 60 * 60 * 24 * 30 });
}
async function clearContact(id) {
  await redis.del(CONTACT_KEY(id));
}

/* –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–¥–ª—è ¬´—É–º–Ω–æ–≥–æ –¥–∞¬ª) */
async function setLastOffer(id, topic) {
  const payload = { topic, ts: Date.now() };
  await redis.set(LAST_OFFER_KEY(id), JSON.stringify(payload), { ex: 60 * 30 });
}
async function getLastOffer(id) {
  const v = await redis.get(LAST_OFFER_KEY(id));
  if (!v) return null;
  try { return JSON.parse(v) } catch { return null; }
}
async function clearLastOffer(id) {
  await redis.del(LAST_OFFER_KEY(id));
}

/* –Ø–∑—ã–∫ */
function detectLang(text) {
  if (!text) return "ru";
  const hasKazChars = /[”ô“ì“õ“£”©“±“Ø“ª—ñ]/i.test(text);
  const hasKazHints = /(—Å–∞–ª–∞–º–∞—Ç|—Å–∞–ª–µ–º|—Å”ô–ª–µ–º|—Ä–∞—Ö–º–µ—Ç|–∂–∞–∫—Å—ã|–∂–∞“õ—Å—ã|–±–∞—Ä\s*–º–∞|—Å–µ–Ω–¥–µ—Ä|—Å–∏–∑–¥–µ—Ä|–∏—è\b|–∂–æ–∫\b|“õ–∞–ª–∞–π)/i.test(text);
  const hasCyr = /[–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–™—ä–´—ã–≠—ç–ô–π]/.test(text);
  if (hasKazChars || hasKazHints) return "kz";
  if (hasCyr) return "ru";
  return "en";
}
function confidentLangSwitch(text) {
  if (!text || text.trim().length === 0) return null;
  if (/—Ä—É—Å—Å–∫|—Ä–æ—Å/iu.test(text)) return "ru";
  if (/–∫–∞–∑–∞–∫|“õ–∞–∑–∞“õ|–∫–∞–∑–∞—Ö/iu.test(text)) return "kz";
  if (/english|–∞–Ω–≥–ª|english please|en\b/iu.test(text)) return "en";
  const hasLatin = /[A-Za-z]/.test(text);
  const hasCyr = /[–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–™—ä–´—ã–≠—ç–ô–π]/.test(text);
  if (hasLatin && !hasCyr) return "en";
  const hasKazChars = /[”ô“ì“õ“£”©“±“Ø“ª—ñ]/i.test(text);
  const hasKazHints = /(—Å–∞–ª–∞–º–∞—Ç|—Å–∞–ª–µ–º|—Ä–∞—Ö–º–µ—Ç|–∂–∞–∫—Å—ã|–±–∞—Ä\s*–º–∞|—Å–µ–Ω–¥–µ—Ä|—Å–∏–∑–¥–µ—Ä|–∏—è\b|–∂–æ–∫\b|“õ–∞–ª–∞–π)/i.test(text);
  if (hasKazChars || hasKazHints) return "kz";
  return null;
}

/* –ò–º—è (–±–µ—Ä—ë–º –∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è), –ø—Ä–æ—Å—Ç–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è */
function normalizeName(name) {
  if (!name) return name;
  let s = String(name).trim();
  s = s.replace(/\b([A-Z–ê-–Ø–Å”ò“í“ö“¢”®“∞“Æ“∫–Ü])([a-z–∞-—è—ë”ô“ì“õ“£”©“±“Ø“ª—ñ-]*)/giu,
    (_, a, b) => a.toUpperCase() + (b || "").toLowerCase()
  );
  return s.trim();
}
function isNameLike(t) {
  if (!t) return false;
  if (/[!?]/.test(t)) return false;
  if ((t.match(/\d/g) || []).length > 0) return false;
  const words = t.trim().split(/\s+/).filter(Boolean);
  if (words.length < 1 || words.length > 2) return false;
  return /^[\p{L}-]+$/u.test(words.join(""));
}

/* –¢–µ–º—ã ‚Äî –∫–∞–∫ –≤ TG */
const TOPIC_PATTERNS = [
  { re: /(–º–∞—Å—à—Ç–∞–±|growth|scale|—Å—Ç—Ä–∞—Ç–µ–≥–∏—è\s*—Ä–∞–∑–≤–∏—Ç–∏—è|–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä(–æ–≤–∞–Ω–∏–µ)?)/i, topic: "–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è" },
  { re: /(–º–∞—Ä–∫–µ—Ç–∏–Ω–≥(–æ–≤—ã–π)?\s*–∞–Ω–∞–ª–∏–∑|–∞–Ω–∞–ª–∏–∑\s*—Ä—ã–Ω–∫–∞|—Ü–µ–ª–µ–≤(–∞—è|–æ–π)\s*–∞—É–¥–∏—Ç–æ—Ä|–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç|—Ü–µ–Ω–æ–æ–±—Ä–∞–∑)/i, topic: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑" },
  { re: /(—Ñ–∏–Ω–∞–Ω—Å(–æ–≤—ã–π)?\s*–∞–Ω–∞–ª–∏–∑|unit\s*economics|—Ñ–∏–Ω–∞–Ω—Å(–æ–≤—ã–π)?\s*–∞—É–¥–∏—Ç|—É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫.*–æ—Ç—á–µ—Ç)/i, topic: "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑" },
  { re: /(—Ñ–∏–Ω–∞–Ω—Å(–æ–≤—ã–π)?\s*–ø–ª–∞–Ω|—Ñ–∏–Ω–º–æ–¥–µ–ª—å|—Ñ–∏–Ω.?–º–æ–¥–µ–ª—å|—Ñ–∏–Ω–∞–Ω—Å(–æ–≤–∞—è)?\s*–º–æ–¥–µ–ª—å|–ø—Ä–æ–≥–Ω–æ–∑|–¥–≤–∏–∂–µ–Ω(–∏–µ)?\s*–¥–µ–Ω–µ–≥|—Ç–æ—á–∫–∞\s*–±–µ–∑—É–±—ã—Ç)/i, topic: "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω" },
  { re: /(–±–∏–∑–Ω–µ—Å.?–ø–ª–∞–Ω|–±–∏–∑–Ω–µ—Å–ø–ª–∞–Ω|swot)/i, topic: "–ë–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω" },
  { re: /(–ø—Ä–µ–∑(–µ–Ω—Ç–∞—Ü(–∏—è|–∏–∏|–∏—é)|–∞|—É|–∫—É|–∫–∞|–µ–Ω—Ç(?![–∞-—è]))(\s*–ø—Ä–æ–µ–∫—Ç–∞|–∫–æ–º–ø–∞–Ω–∏–∏|–æ –∫–æ–º–ø–∞–Ω–∏–∏)?|pitch\s*deck)/i, topic: "–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞" },
  { re: /(–∏–Ω–≤–µ—Å—Ç–∏—Ü|investment|–ø–æ–∏—Å–∫\s*–∏–Ω–≤–µ—Å—Ç–æ—Ä)/i, topic: "–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π" },
  { re: /(—Å—Ç—Ä–∞—Ç–µ–≥–∏(—è)?\s*—Ä–∞–∑–≤–∏—Ç–∏—è|vision)/i, topic: "–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è" },
  { re: /(–∫–æ–Ω—Ü–µ–ø—Ü(–∏—è)?\s*—Ä–∞–±–æ—Ç—ã|–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ|–∏–º–∏–¥–∂–µ–≤)/i, topic: "–ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ä–∞–±–æ—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏" },
  { re: /(–±–∏–∑–Ω–µ—Å.?–ø—Ä–æ—Ü–µ—Å—Å|—Ä–µ–≥–ª–∞–º–µ–Ω—Ç|–æ–ø—Ç–∏–º–∏–∑–∞—Ü|–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü|crm(?!\s*–≤–µ–¥–µ–Ω))/i, topic: "–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã/–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è" },
  { re: /(–ª–æ–≥–æ—Ç–∏–ø|–ª–æ–≥–æ\b|logo|–±—Ä–µ–Ω–¥(–∏–Ω–≥)?|—Ñ–∏—Ä–º–µ–Ω–Ω(—ã–π|–æ–≥–æ)?\s*—Å—Ç–∏–ª)/i, topic: "–õ–æ–≥–æ—Ç–∏–ø –∏ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å" },
  { re: /(–±—Ä–µ–Ω–¥.?–±—É–∫|–±—Ä—ç–Ω–¥.?–±—É–∫|brand.?book|–≥–∞–π–¥–ª–∞–π–Ω|guideline)/i, topic: "–ë—Ä–µ–Ω–¥–±—É–∫" },
  { re: /(—Å–∞–π—Ç|–≤–µ–±.?—Å–∞–π—Ç|web\s*site|site|–ª–µ–Ω–¥–∏–Ω–≥|–ª—ç–Ω–¥–∏–Ω–≥|landing)/i, topic: "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞" },
  { re: /(—Ä–µ–∫–ª–∞–º(–∞|—É|—ã|–µ|–æ–π)\b|—Ç–∞—Ä–≥–µ—Ç(?![–∞-—è])|—Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥(?![–∞-—è])|google.?ads|–∫–æ–Ω—Ç–µ–∫—Å—Ç|–∫–º—Å|gdn|ppc|2gis|olx)/i, topic: "–†–µ–∫–ª–∞–º–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ" },
  { re: /(—Å–º–º|smm|–∏–Ω—Å—Ç–∞–≥—Ä–∞–º|instagram|stories|reels|–∫–æ–Ω—Ç–µ–Ω—Ç\s*–º–∞—Ä–∫–µ—Ç–∏–Ω–≥)/i, topic: "SMM –≤–µ–¥–µ–Ω–∏–µ" },
  { re: /(–æ—Ç–¥–µ–ª\s*–ø—Ä–æ–¥–∞–∂|—Å–∫—Ä–∏–ø—Ç|—Ö–æ–ª–æ–¥–Ω(—ã–µ)?\s*–∑–≤–æ–Ω|kpi|–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ\s*–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ|–º–µ–Ω–µ–¥–∂–µ—Ä)/i, topic: "–û—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂" },
  { re: /(crm|–±–∏—Ç—Ä–∏–∫—Å.?24|—Ü—Ä–º|—Å—Ä–º|amo.?crm|bitrix|—Å–∫–≤–æ–∑–Ω.*–∞–Ω–∞–ª–∏—Ç–∏–∫|chat.?bot|—á–∞—Ç.?–±–æ—Ç|–∏–∏.?–±–æ—Ç|ai.?bot)/i, topic: "CRM, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –ò–ò" },
  { re: /(—Ñ—Ä–∞–Ω—à–∏–∑|franchise|—Ñ—Ä–∞–Ω—á–∞–π–∑–∏.?–Ω–≥)/i, topic: "–§—Ä–∞–Ω—á–∞–π–∑–∏–Ω–≥" },
  { re: /(–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥|gtm|go.?to.?market|—Å—Ç—Ä–∞—Ç–µ–≥–∏—è\s*–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è)/i, topic: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥/—Ä–µ–∫–ª–∞–º–∞" },
];
function guessTopicsAll(userText) {
  const u = (userText || "").toLowerCase();
  const set = new Set();
  for (const p of TOPIC_PATTERNS) if (p.re.test(u)) set.add(p.topic);
  return Array.from(set);
}

/* –ù–∞—É—á–∏–º –±–æ—Ç–∞ –ø–æ–Ω–∏–º–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç ¬´–ò–º—è, –ì–æ—Ä–æ–¥, –°—Ñ–µ—Ä–∞¬ª –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ */
function parseInlineLead(text) {
  if (!text) return null;
  const parts = text.split(/[,\n;/]+/).map(s => s.trim()).filter(Boolean);
  if (parts.length >= 3) {
    const name = normalizeName(parts[0]);
    const city = parts[1].slice(0, 100);
    const sphere = parts.slice(2).join(", ").slice(0, 200);
    if (isNameLike(name)) return { name, city, sphere };
  }
  return null;
}

/* –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è + –ø—Ä–æ—Ñ–∏–ª—è WA */
async function tryAutofillFrom(id, booking, userText, waProfileName) {
  if (!booking.name && waProfileName && isNameLike(waProfileName)) {
    booking.name = normalizeName(waProfileName);
  }
  const topicsHit = guessTopicsAll(userText);
  if (!booking.topic && topicsHit.length === 1) booking.topic = topicsHit[0];
  if (topicsHit.length > 1) booking.topic = COMBINE_MULTI_TOPICS ? topicsHit.join(", ") : topicsHit[0];
  return booking;
}

/* –ü—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª–æ—Ç–æ–≤ */
function hasAllBookingFields(b) {
  const hasTopic = b.topic && b.topic.trim().length;
  return !!(b && hasTopic && b.name && b.city && b.sphere);
}
function decideNextStage(b) {
  if (!b.name) return "name";
  if (!b.city) return "city";
  if (!b.sphere) return "sphere";
  return null;
}

/* –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (–∫—Ä–∞—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏) */
const L = {
  hi: {
    ru: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ START. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
    kz: "–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! –ú–µ–Ω START –∫–æ–º–ø–∞–Ω–∏—è—Å—ã–Ω—ã“£ –ñ–ò-–∫”©–º–µ–∫—à—ñ—Å—ñ–º—ñ–Ω. “ö–∞–ª–∞–π –∫”©–º–µ–∫—Ç–µ—Å–µ –∞–ª–∞–º—ã–Ω?",
    en: "Hello! I‚Äôm START company‚Äôs AI assistant. How can I help?",
  },
  askOnlyName: {
    ru: "–°–ø–∞—Å–∏–±–æ! –ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è (–∏–º—è)?",
    kz: "–†–∞“õ–º–µ—Ç! –ï—Å—ñ–º—ñ“£—ñ–∑ “õ–∞–ª–∞–π?",
    en: "Thanks! What‚Äôs your name?",
  },
  askCity: {
    ru: "–ò –ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥ –æ–±—Ä–∞—â–µ–Ω–∏—è?",
    kz: "“ö–∞–π “õ–∞–ª–∞–¥–∞–Ω –∂–∞–∑—ã–ø –æ—Ç—ã—Ä—Å—ã–∑?",
    en: "And which city are you in?",
  },
  askSphere: {
    ru: "–ò –µ—â—ë: –≤ –∫–∞–∫–æ–π —Å—Ñ–µ—Ä–µ —Ä–∞–±–æ—Ç–∞–µ—Ç–µ (—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å)?",
    kz: "–¢–∞“ì—ã: “õ–∞–π —Å–∞–ª–∞–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π—Å—ñ–∑ (–Ω–µ–º–µ–Ω –∞–π–Ω–∞–ª—ã—Å–∞—Å—ã–∑)?",
    en: "One more: what‚Äôs your business field?",
  },
  booked: {
    ru: "–ü–µ—Ä–µ–¥–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–µ–Ω–µ–¥–∂–µ—Ä—É. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏. –°–ø–∞—Å–∏–±–æ!",
    kz: "–ê“õ–ø–∞—Ä–∞—Ç—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–≥–µ –±–µ—Ä–µ–º—ñ–Ω. –ë—ñ–∑ —Å—ñ–∑–±–µ–Ω —Ö–∞–±–∞—Ä–ª–∞—Å–∞–º—ã–∑. –†–∞—Ö–º–µ—Ç!",
    en: "I‚Äôm passing this to a manager. We‚Äôll contact you. Thank you!",
  },
  resetDone: {
    ru: "–ò—Å—Ç–æ—Ä–∏—è –∏ –∑–∞—è–≤–∫–∞ –æ—á–∏—â–µ–Ω—ã. –ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ.",
    kz: "–¢–∞—Ä–∏—Ö –ø–µ–Ω ”©—Ç—ñ–Ω—ñ–º —Ç–∞–∑–∞—Ä—Ç—ã–ª–¥—ã. “ö–∞–π—Ç–∞ –±–∞—Å—Ç–∞–π—ã“õ.",
    en: "History and booking cleared. Let‚Äôs start over.",
  },
};

/* –†–µ–∫–≤–∏–∑–∏—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ */
const COMPANY_INFO = {
  address: "–≥. –ê—Å—Ç–∞–Ω–∞, —à–æ—Å—Å–µ –ö–æ—Ä–≥–∞–ª–∂—ã–Ω, 3, –ë–¶ SMART, 4 —ç—Ç–∞–∂, –æ—Ñ–∏—Å 405",
  phone: "+77776662115",
  worktime: "–ü–Ω‚Äì–ü—Ç, 10:00‚Äì18:00",
  site: "https://strateg.kz",
};

/* –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ–¥ WA (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –≤—Ä–µ–º–µ–Ω–∏/–¥–∞—Ç !) */
const baseSystemPrompt = `
–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ START (–≥. –ê—Å—Ç–∞–Ω–∞).
–ö—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π –¢–û–õ–¨–ö–û –ø–æ —É—Å–ª—É–≥–∞–º –∏–∑ –±–ª–æ–∫–∞ SERVICES_TEXT –Ω–∏–∂–µ, –∑–∞—Ç–µ–º —É–º–µ—Å—Ç–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–ª–æ–≤–∞ ¬´—Å–µ–≥–æ–¥–Ω—è/today¬ª.
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–æ—Å–∏/–Ω–µ —É–ø–æ–º–∏–Ω–∞–π –≤—Ä–µ–º—è, –¥–∞—Ç—É –∏–ª–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî —ç—Ç–∏–º –∑–∞–π–º—ë—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä.
–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ü–µ–Ω—ã/—Å—Ä–æ–∫–∏ ‚Äî –æ—Ç–≤–µ—á–∞–π, —á—Ç–æ —Ä–∞—Å—á—ë—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ—Å–ª–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.
–ê–¥—Ä–µ—Å: ${COMPANY_INFO.address}. –¢–µ–ª–µ—Ñ–æ–Ω: ${COMPANY_INFO.phone}. –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${COMPANY_INFO.worktime}. –ê–¥—Ä–µ—Å —Å–∞–π—Ç–∞: ${COMPANY_INFO.site}.
–ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—á–µ–Ω—å —É—Å–ª—É–≥: —Å–º. –±–ª–æ–∫ SERVICES_TEXT (–∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–∏ —É—Å–ª—É–≥–∏).
`;

/* –ê–¥–º–∏–Ω (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TG, –∫–∞–∫ –≤ —Ç–≤–æ—ë–º –ø—Ä–æ–µ–∫—Ç–µ) */
function getAdminId() {
  const raw = (process.env.ADMIN_CHAT_ID || "").replace(/^[\'"]|[\'"]$/g, "");
  return raw;
}
async function sendTG(chatId, text) {
  if (!process.env.TELEGRAM_BOT_TOKEN) return;
  const resp = await fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chat_id: chatId, text }),
  });
  if (!resp.ok) {
    const body = await resp.text();
    console.error("sendTG error", resp.status, body, "chat_id=", chatId);
  }
  return resp;
}

/* –û—Ç–ø—Ä–∞–≤–∫–∞ WA-—Å–æ–æ–±—â–µ–Ω–∏–π (—Å –ø–∞—Ç—á–µ–º –Ω–∞ "8") */
async function sendWA(toWaId, text) {
  const url = `https://graph.facebook.com/v20.0/${META_WA_PHONE_NUMBER_ID}/messages`;
  async function _post(to) {
    const payload = {
      messaging_product: "whatsapp",
      to: String(to),
      text: { body: text?.slice(0, 3500) || "" },
    };
    const resp = await fetch(url, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${META_WA_TOKEN}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    });
    return resp;
  }
  // 1) –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π waId (–Ω–∞–ø—Ä–∏–º–µ—Ä 7702...)
  let resp = await _post(toWaId);
  if (!resp.ok) {
    const body = await resp.text();
    // –ï—Å–ª–∏ Meta —Ä—É–≥–∞–µ—Ç—Å—è –Ω–∞ allow-list (#131030) ‚Äî –ø—Ä–æ–±—É–µ–º ¬´–∫–∞–∑–∞—Ö—Å–∫–∏–π –≥–ª—é–∫¬ª 78...
    if (body.includes('"code":131030')) {
      // –≤—Å—Ç–∞–≤–ª—è–µ–º '8' —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π '7'
      const alt = /^7\d+$/.test(toWaId) && !toWaId.startsWith('78')
        ? ('78' + String(toWaId).slice(1))
        : toWaId;
      if (alt !== toWaId) {
        const resp2 = await _post(alt);
        if (!resp2.ok) {
          const body2 = await resp2.text();
          console.error("sendWA retry error", resp2.status, body2);
        }
        return resp2;
      }
    }
    console.error("sendWA error", resp.status, body);
  }
  return resp;
}

/* –ü–æ–¥–ø–∏—Å—å –≤–µ–±—Ö—É–∫–∞ (X-Hub-Signature-256) ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ */
function verifyMetaSignature(appSecret, signature, rawBody) {
  try {
    if (!appSecret || !signature || !rawBody) return true; // –º—è–≥–∫–∏–π —Ä–µ–∂–∏–º
    const expected = "sha256=" + crypto.createHmac("sha256", appSecret).update(rawBody, "utf8").digest("hex");
    return crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(expected));
  } catch {
    return false;
  }
}

/* =========================
   –û–°–ù–û–í–ù–û–ô –•–ï–ù–î–õ–ï–† –î–õ–Ø VERCEL
   ========================= */
export default async function handler(req, res) {
  try {
    // 1) –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (GET)
    if (req.method === "GET") {
      const mode = req.query["hub.mode"];
      const token = req.query["hub.verify_token"];
      const challenge = req.query["hub.challenge"];
      if (mode === "subscribe" && token === META_WA_VERIFY_TOKEN) {
        res.statusCode = 200;
        return res.end(challenge);
      }
      res.statusCode = 403;
      return res.end("Forbidden");
    }

    // 2) –í—Ö–æ–¥—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è (POST)
    if (req.method !== "POST") {
      res.statusCode = 405;
      return res.end("Method Not Allowed");
    }

    const raw = await readBody(req);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
    const sig = req.headers["x-hub-signature-256"];
    if (!verifyMetaSignature(META_APP_SECRET, sig, raw)) {
      res.statusCode = 401;
      return res.end("Invalid signature");
    }

    const update = raw ? JSON.parse(raw) : {};
    if (!update?.entry?.length) {
      res.statusCode = 200;
      return res.end(JSON.stringify({ ok: true }));
    }

    // WA —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–∞—á–∫–∞–º–∏
    for (const entry of update.entry) {
      const changes = entry.changes || [];
      for (const ch of changes) {
        const value = ch.value || {};
        const messages = value.messages || [];
        const contacts = value.contacts || [];

        // —Å—Ç–∞—Ç—É—Å—ã, —à–∞–±–ª–æ–Ω—ã –∏ —Ç.–ø. –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        if (!messages.length) continue;

        // –ë–µ—Ä—ë–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const msg = messages[0];
        const waId = msg.from; // —Å—Ç—Ä–æ–∫–∞ —Å –Ω–æ–º–µ—Ä–æ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ 79... –∏–ª–∏ 770...
        const waProfileName = contacts?.[0]?.profile?.name || null;

        // –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        const userText = msg?.text?.body?.trim() || "";

        // –ö–æ–º–∞–Ω–¥—ã
        if (/^\/reset\b/i.test(userText)) {
          await redis.del(`hist:${waId}`);
          await redis.del(BOOK_KEY(waId));
          await clearContact(waId);
          await clearLastOffer(waId);
          const current = (await redis.get(LANG_KEY(waId))) || "ru";
          await redis.set(LANG_KEY(waId), current, { ex: 60 * 60 * 24 * 30 });
          await sendWA(waId, L.resetDone[current] || L.resetDone.ru);
          continue;
        }
        if (/^\/whoami\b/i.test(userText)) {
          await sendWA(waId, `wa_id: ${waId}`);
          continue;
        }
        if (/^\/lang\b/i.test(userText)) {
          const parts = userText.split(/\s+/);
          const code = (parts[1] || "").toLowerCase();
          if (code === "ru" || code === "kz" || code === "en") {
            await redis.set(LANG_KEY(waId), code, { ex: 60 * 60 * 24 * 30 });
            await sendWA(waId, `–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${code}.`);
          } else {
            const current = (await redis.get(LANG_KEY(waId))) || detectLang(userText) || "ru";
            await sendWA(waId, (current === "kz")
              ? "“ö–æ–ª–¥–∞—É –∫”©—Ä—Å–µ—Ç—ñ–ª–µ—Ç—ñ–Ω —Ç—ñ–ª–¥–µ—Ä: ru, kz, en. –ú—ã—Å–∞–ª: /lang kz"
              : (current === "en")
              ? "Supported languages: ru, kz, en. Example: /lang en"
              : "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏: ru, kz, en. –ü—Ä–∏–º–µ—Ä: /lang ru");
          }
          continue;
        }

        // –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const stored = await redis.get(LANG_KEY(waId));
        const guess = confidentLangSwitch(userText);
        let lang = stored || guess || detectLang(userText) || "ru";
        if (!stored || (guess && guess !== stored)) {
          lang = guess || lang;
          await redis.set(LANG_KEY(waId), lang, { ex: 60 * 60 * 24 * 30 });
        }

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const historyBefore = await getHistory(waId);
        if (historyBefore.length === 0) {
          const hi = L.hi[lang] || L.hi.ru;
          await pushHistory(waId, "user", userText || "[non-text]");
          await pushHistory(waId, "assistant", hi);
          await sendWA(waId, hi);
          continue;
        }

        // –î–æ—Å—Ç–∞—ë–º —Å–ª–æ—Ç—ã/–∫–æ–Ω—Ç–∞–∫—Ç
        const booking = await getBooking(waId);
        const contact = (await getContact(waId)) || {};
        await tryAutofillFrom(waId, booking, userText, contact.name || waProfileName);
        await setBooking(waId, booking); // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–µ–º—ã/–∏–º—è –≤ Redis

        // ¬´–ß–µ–ª–æ–≤–µ–∫/–æ–ø–µ—Ä–∞—Ç–æ—Ä¬ª
        if (/\b(—á–µ–ª–æ–≤–µ–∫|–æ–ø–µ—Ä–∞—Ç–æ—Ä|–º–µ–Ω–µ–¥–∂–µ—Ä|—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç|–ø–µ—Ä–µ–∫–ª—é—á–∏|–ø–æ–∑–æ–≤–∏|–ø—Ä–∏–≥–ª–∞—Å–∏|call me|talk to human)\b/iu.test(userText)) {
          await notifyLead(waId, booking.topic || "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è", normalizeName(booking.name || waProfileName || "‚Äî"), booking.city || "‚Äî", booking.sphere || "‚Äî");
          await clearBooking(waId);
          await clearLastOffer(waId);
          await sendWA(waId, (lang === "kz") ? "–ú–µ–Ω–µ–¥–∂–µ—Ä–¥—ñ —à–∞“õ—ã—Ä–∞–º—ã–Ω. –ñ–∞“õ—ã–Ω–¥–∞ —Ö–∞–±–∞—Ä–ª–∞—Å–∞–º—ã–∑." :
                         (lang === "en") ? "I‚Äôll bring a manager in. We‚Äôll reach out shortly." :
                                           "–ü—Ä–∏–≥–ª–∞—à–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞. –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è.");
          continue;
        }

        // ===== ¬´–£–ú–ù–û–ï –°–û–ì–õ–ê–°–ò–ï¬ª =====
        const consentRe = /\b(–¥–∞–≤–∞–π—Ç–µ|–¥–∞–≤–∞–π|—Ö–æ—á—É|–Ω—É–∂–Ω–æ|–Ω—É–∂–Ω–∞|–Ω—É–∂–µ–Ω|–æ—Ñ–æ—Ä–º–∏–º|–æ—Ñ–æ—Ä–º–∏—Ç—å|–≥–æ—Ç–æ–≤|–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç\s*–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü|–ø–æ–µ—Ö–∞–ª–∏|–∑–∞–ø–∏—à–∏—Ç–µ|–∑–∞–ø–∏—Å–∞—Ç—å|–Ω—É\s*–¥–∞|–∞–≥–∞|—É–≥—É|–æ–∫|–æ–∫–µ–π|ok|okey|—Ö–æ—Ä–æ—à–æ|go|–¥–∞|yes|–∏”ô|–∏—è)\b/iu;
        if (consentRe.test(userText)) {
          // —Ç–µ–º–∞ ‚Äî –∏–∑ last_offer –∏–ª–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–ø–ª–∏–∫
          let topicToBook = null;
          const offer = await getLastOffer(waId);
          const fresh = offer && (Date.now() - (offer.ts || 0) < 10 * 60 * 1000);
          if (fresh && offer.topic) topicToBook = offer.topic;
          if (!topicToBook) {
            const hist = await getHistory(waId);
            const prevUser = [...hist].filter(h => h.role === "user").slice(-1)[0]?.content || "";
            const prevA    = [...hist].filter(h => h.role === "assistant").slice(-1)[0]?.content || "";
            const fromUser = guessTopicsAll(prevUser);
            const fromA    = guessTopicsAll(prevA);
            let picked     = (fromUser.length ? fromUser : fromA);
            if (!picked.length && /(–ø—Ä–µ–∑(–∞|—É|–∫—É|–∫–∞)|–ø—Ä–µ–∑–µ–Ω—Ç(?![–∞-—è]))/i.test(prevUser)) picked = ["–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞"];
            if (picked.length) {
              topicToBook = COMBINE_MULTI_TOPICS ? picked.join(", ") : picked[0];
              await setLastOffer(waId, COMBINE_MULTI_TOPICS ? picked.join(", ") : picked[0]);
            }
          }
          if (topicToBook) booking.topic = booking.topic || topicToBook;
          // –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è
          const next = decideNextStage(booking);
          if (!next && hasAllBookingFields(booking)) {
            const name = normalizeName(booking.name || waProfileName || "‚Äî");
            await notifyLead(waId, booking.topic, name, booking.city, booking.sphere);
            await setContact(waId, { name });
            await clearBooking(waId);
            await clearLastOffer(waId);
            const txt = L.booked[lang] || L.booked.ru;
            await pushHistory(waId, "user", userText);
            await pushHistory(waId, "assistant", txt);
            await sendWA(waId, txt);
            continue;
          } else {
            // —Å–ø—Ä–æ—Å–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Å–ª–æ—Ç
            booking.stage = next || "name";
            await setBooking(waId, booking);
            const prompt = (booking.stage === "name")
              ? (L.askOnlyName[lang] || L.askOnlyName.ru)
              : (booking.stage === "city")
              ? (L.askCity[lang] || L.askCity.ru)
              : (L.askSphere[lang] || L.askSphere.ru);
            await pushHistory(waId, "user", userText);
            await pushHistory(waId, "assistant", prompt);
            await sendWA(waId, prompt);
            continue;
          }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–¥–∏–π
        if (booking.stage === "name") {
          const candidate = userText;
          if (isNameLike(candidate)) {
            booking.name = normalizeName(candidate);
            // —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
            booking.stage = "city";
            await setBooking(waId, booking);
            const prompt = L.askCity[lang] || L.askCity.ru;
            await pushHistory(waId, "user", userText);
            await pushHistory(waId, "assistant", prompt);
            await sendWA(waId, prompt);
            continue;
          } else {
            const prompt = (lang === "kz") ? "–ï—Å—ñ–º—ñ“£—ñ–∑–¥—ñ ”ô—Ä—ñ–ø—Ç–µ—Ä–º–µ–Ω “ì–∞–Ω–∞ –∂–∞–∑—ã“£—ã–∑ (–º—ã—Å.: –ê–ª–∏–Ω–∞)." :
                           (lang === "en") ? "Please send just your name (letters only)." :
                                             "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–∏–Ω–∞).";
            await pushHistory(waId, "user", userText);
            await pushHistory(waId, "assistant", prompt);
            await sendWA(waId, prompt);
            continue;
          }
        }

        if (booking.stage === "city") {
          booking.city = userText.trim().slice(0, 100);
          booking.stage = "sphere";
          await setBooking(waId, booking);
          const prompt = L.askSphere[lang] || L.askSphere.ru;
          await pushHistory(waId, "user", userText);
          await pushHistory(waId, "assistant", prompt);
          await sendWA(waId, prompt);
          continue;
        }

        if (booking.stage === "sphere") {
          booking.sphere = userText.trim().slice(0, 200);
          booking.stage = null;
          if (!booking.topic) {
            const topics = guessTopicsAll(userText);
            if (topics.length) {
              booking.topic = COMBINE_MULTI_TOPICS ? topics.join(", ") : topics[0];
            } else {
              const offer = await getLastOffer(waId);
              booking.topic = (offer && offer.topic) || "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è";
            }
          }

          if (hasAllBookingFields(booking)) {
            const name = normalizeName(booking.name || waProfileName || "‚Äî");
            await notifyLead(waId, booking.topic, name, booking.city, booking.sphere);
            await setContact(waId, { name });
            await clearBooking(waId);
            await clearLastOffer(waId);
            const txt = L.booked[lang] || L.booked.ru;
            await pushHistory(waId, "user", userText);
            await pushHistory(waId, "assistant", txt);
            await sendWA(waId, txt);
            continue;
          } else {
            // —á—Ç–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ ‚Äî —Å–ø—Ä–æ—Å–∏–º —Å–ª–µ–¥—É—é—â–µ–µ –ø–æ–ª–µ
            const next = decideNextStage(booking) || "name";
            booking.stage = next;
            await setBooking(waId, booking);
            const prompt = (next === "name")
              ? (L.askOnlyName[lang] || L.askOnlyName.ru)
              : (next === "city")
              ? (L.askCity[lang] || L.askCity.ru)
              : (L.askSphere[lang] || L.askSphere.ru);
            await pushHistory(waId, "user", userText);
            await pushHistory(waId, "assistant", prompt);
            await sendWA(waId, prompt);
            continue;
          }
        }

         // ==== –û–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–∞—è –∑–∞—è–≤–∫–∞: "–ò–º—è, –ì–æ—Ä–æ–¥, –°—Ñ–µ—Ä–∞" ====
         const inline = parseInlineLead(userText);
         if (inline) {
           booking.name = booking.name || inline.name;
           booking.city = booking.city || inline.city;
           booking.sphere = booking.sphere || inline.sphere;
           if (!booking.topic) {
              const tNow = guessTopicsAll(userText);
              if (tNow.length) {
                booking.topic = COMBINE_MULTI_TOPICS ? tNow.join(", ") : tNow[0];
              } else {
                const offer = await getLastOffer(waId);
                booking.topic = (offer && offer.topic) || "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è";
              }
            }

           if (hasAllBookingFields(booking)) {
             const name = normalizeName(booking.name || waProfileName || "‚Äî");
             await notifyLead(waId, booking.topic, name, booking.city, booking.sphere);
             await setContact(waId, { name });
             await clearBooking(waId);
             await clearLastOffer(waId);
             const txt = L.booked[lang] || L.booked.ru;
             await pushHistory(waId, "user", userText);
             await pushHistory(waId, "assistant", txt);
             await sendWA(waId, txt);
             continue;
           } else {
             // —Å–ø—Ä–æ—Å–∏–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ
             const next = decideNextStage(booking) || "name";
             booking.stage = next;
             await setBooking(waId, booking);
             const prompt = (next === "name")
               ? (L.askOnlyName[lang] || L.askOnlyName.ru)
               : (next === "city")
               ? (L.askCity[lang] || L.askCity.ru)
               : (L.askSphere[lang] || L.askSphere.ru);
             await pushHistory(waId, "user", userText);
             await pushHistory(waId, "assistant", prompt);
             await sendWA(waId, prompt);
             continue;
           }
         }

        // ===== –ò–ò-–æ—Ç–≤–µ—Ç + –º—è–≥–∫–∏–π –æ—Ñ—Ñ–µ—Ä (–±–µ–∑ –∑–∞–ø—É—Å–∫–∞ —Å–ª–æ—Ç–æ–≤) =====
        const history = await getHistory(waId);
        const languageLine = lang === "ru"
          ? "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
          : lang === "kz"
          ? "–ñ–∞—É–∞–ø—Ç—ã “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ –±–µ—Ä."
          : "Reply in English.";

        const systemPrompt = `${baseSystemPrompt}\n\n=== SERVICES_TEXT START ===\n${SERVICES_TEXT}\n=== SERVICES_TEXT END ===\n${languageLine}`;

        const messagesToLLM = [
          { role: "system", content: systemPrompt },
          ...history,
          { role: "user", content: userText },
        ];
        const completion = await openai.chat.completions.create({
          model: "gpt-4o-mini",
          messages: messagesToLLM,
          temperature: 0.2,
        });
        let reply = completion.choices?.[0]?.message?.content?.slice(0, 3500) || "";

        // –º—è–≥–∫–∏–π –æ—Ñ—Ñ–µ—Ä —Å —Ñ–∏–∫—Å–∞—Ü–∏–µ–π last_offer
        const topicsNow = guessTopicsAll(userText);
        const replyTopics = guessTopicsAll(reply);
         
        if (!booking.stage && topicsNow.length > 0) {
          const topicLabel = COMBINE_MULTI_TOPICS ? topicsNow.join(", ") : topicsNow[0];
          const plural = (topicsNow.length > 1);
          const ruLine = plural
            ? `\n\n–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ —Ç–µ–º–∞–º: ${topicLabel}. –î–ª—è —ç—Ç–æ–≥–æ –ø—Ä–∏—à–ª–∏—Ç–µ –ò–º—è, –ì–æ—Ä–æ–¥ –∏ –°—Ñ–µ—Ä—É –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.`
            : `\n\n–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ —Ç–µ–º–µ: ${topicLabel}. –î–ª—è —ç—Ç–æ–≥–æ –ø—Ä–∏—à–ª–∏—Ç–µ –ò–º—è, –ì–æ—Ä–æ–¥ –∏ –°—Ñ–µ—Ä—É –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.`;
          const kzLine = plural
            ? `\n\n“ö–∞–ª–∞—Å–∞“£—ã–∑, –∫–µ–ª–µ—Å—ñ —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –¥–∞–π—ã–Ω–¥–∞–π–º—ã–Ω: ${topicLabel}. –û–ª “Ø—à—ñ–Ω –ê—Ç—ã“£—ã–∑–¥—ã, “ö–∞–ª–∞“£—ã–∑–¥—ã –∂”ô–Ω–µ –°—Ñ–µ—Ä–∞“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑.`
            : `\n\n“ö–∞–ª–∞—Å–∞“£—ã–∑, ${topicLabel} –±–æ–π—ã–Ω—à–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –¥–∞–π—ã–Ω–¥–∞–π–º—ã–Ω. –û–ª “Ø—à—ñ–Ω –ê—Ç—ã“£—ã–∑–¥—ã, “ö–∞–ª–∞“£—ã–∑–¥—ã –∂”ô–Ω–µ –°—Ñ–µ—Ä–∞“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑.`;
          const enLine = plural
            ? `\n\nIf you want, I‚Äôll arrange a consultation on these topics: ${topicLabel}. Please send your Name, City and Business field.`
            : `\n\nIf you want, I‚Äôll arrange a consultation on: ${topicLabel}. Please send your Name, City and Business field.`;
         
          reply = (reply || "").trim() + (lang === "kz" ? kzLine : lang === "en" ? enLine : ruLine);
         
          await setLastOffer(waId, topicLabel); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—é —Å—Ç—Ä–æ–∫—É —Ç–µ–º
          booking.topic = topicLabel;
          await setBooking(waId, booking);
        }
          else if (!booking.stage && topicsNow.length === 0 && replyTopics.length === 1) {
          await setLastOffer(waId, replyTopics[0]);
        }

        if (!reply || reply.trim().length < 3) {
          reply = (lang === "ru") ? "–ì–æ—Ç–æ–≤–æ. –ß–µ–º –µ—â—ë –ø–æ–º–æ—á—å?"
                : (lang === "kz") ? "–î–∞–π—ã–Ω. –¢–∞“ì—ã –Ω–µ –∫”©–º–µ–∫—Ç–µ—Å–µ–π—ñ–Ω?"
                : "All set. How else can I help?";
        }

        await pushHistory(waId, "user", userText);
        await pushHistory(waId, "assistant", reply);
        await sendWA(waId, reply);
      }
    }

    res.statusCode = 200;
    res.end(JSON.stringify({ ok: true }));
  } catch (err) {
    console.error(err);
    res.statusCode = 500;
    res.end("Internal Error");
  }
}

/* =========================
   –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï: –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–∞ –∞–¥–º–∏–Ω—É
   ========================= */
async function notifyLead(waId, topic, name, city, sphere) {
  const adminId = getAdminId();
  const finalTopic = topic || "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è";
  const finalName = normalizeName(name || "");
  const msg =
    `üÜï –õ–∏–¥ –∏–∑ WhatsApp:\n` +
    `–¢–µ–º–∞: ${finalTopic}\n` +
    `–ò–º—è: ${finalName || "-"}\n` +
    `–ì–æ—Ä–æ–¥: ${city || "-"}\n` +
    `–°—Ñ–µ—Ä–∞: ${sphere || "-"}\n` +
    `–ò—Å—Ç–æ—á–Ω–∏–∫: wa_id ${waId}`;
  if (adminId && process.env.TELEGRAM_BOT_TOKEN) {
    await sendTG(adminId, msg);
  } else {
    console.log("[LEAD]", msg);
  }
}
