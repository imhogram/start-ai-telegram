import OpenAI from "openai";
import { Redis } from "@upstash/redis";

// ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ ====
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});

// ==== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ====
const HISTORY_LEN = 8; // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 8 —Å–æ–æ–±—â–µ–Ω–∏–π
const LANG_KEY = (chatId) => `lang:${chatId}`;

// ==== –£—Ç–∏–ª–∏—Ç–∞ —á—Ç–µ–Ω–∏—è "—Å—ã—Ä–æ–≥–æ" —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ (–Ω—É–∂–Ω–æ –¥–ª—è serverless) ====
async function readBody(req) {
  return await new Promise((resolve, reject) => {
    let data = "";
    req.on("data", chunk => (data += chunk));
    req.on("end", () => resolve(data));
    req.on("error", reject);
  });
}

// ==== –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ Redis ====
function safeParseItem(item) {
  if (item == null) return null;
  if (typeof item === "object") return item; // —É–∂–µ –æ–±—ä–µ–∫—Ç
  if (typeof item === "string") {
    try { return JSON.parse(item); } catch { return null; }
  }
  return null;
}

// ==== –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ ====
async function getHistory(chatId) {
  const items = await redis.lrange(`hist:${chatId}`, -HISTORY_LEN, -1);
  return (items || []).map(safeParseItem).filter(Boolean);
}
async function pushHistory(chatId, role, content) {
  const entry = { role, content };
  await redis.rpush(`hist:${chatId}`, JSON.stringify(entry));
  await redis.ltrim(`hist:${chatId}`, -HISTORY_LEN, -1);
}

// ==== –ú–∞—à–∏–Ω–∞ —Å–ª–æ—Ç–æ–≤ –∑–∞–ø–∏—Å–∏ ====
async function getBooking(chatId) {
  const val = await redis.get(`book:${chatId}`);
  if (!val) {
    return { stage: null, topic: null, when: null, name: null, phone: null };
  }
  if (typeof val === "object") return val;
  try { return JSON.parse(val); } catch {
    return { stage: null, topic: null, when: null, name: null, phone: null };
  }
}
async function setBooking(chatId, data) {
  await redis.set(`book:${chatId}`, JSON.stringify(data), { ex: 60 * 60 * 24 });
}
async function clearBooking(chatId) {
  await redis.del(`book:${chatId}`);
}

// ==== –î–µ—Ç–µ–∫—Ç —è–∑—ã–∫–∞ (ru/kz/en) —Å —É—á—ë—Ç–æ–º "kz –±–µ–∑ –¥–∏–∞–∫—Ä–∏—Ç–∏–∫" ====
function detectLang(text) {
  if (!text) return "ru";
  const hasKazChars = /[”ô“ì“õ“£”©“±“Ø“ª—ñ]/i.test(text);
  const hasKazHints = /(—Å–∞–ª–∞–º–∞—Ç|—Å–∞–ª–µ–º|—Å”ô–ª–µ–º|—Ä–∞—Ö–º–µ—Ç|–∂–∞–∫—Å—ã|–∂–∞“õ—Å—ã|–±–∞—Ä\s*–º–∞|–±–∞—Ä–º–∞|—Å–µ–Ω–¥–µ—Ä|—Å–∏–∑–¥–µ—Ä|—Å—ñ–∑–¥–µ—Ä|—Å–∏–∑|—Å—ñ–∑|–∏—è\b|–∏–∞\b|–∂–æ–∫\b|–∂–æ“õ\b|–∫–∞–ª–∞–π|“õ–∞–ª–∞–π)/i.test(text);
  const hasCyr = /[–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–™—ä–´—ã–≠—ç–ô–π]/.test(text);
  if (hasKazChars || hasKazHints) return "kz";
  if (hasCyr) return "ru";
  return "en";
}

// ==== "–£–≤–µ—Ä–µ–Ω–Ω–æ–µ" –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ (–Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ —Ü–∏—Ñ—Ä—ã/—ç–º–æ–¥–∑–∏) ====
function confidentLangSwitch(text) {
  if (!text || text.trim().length === 0) return null;
  if (/—Ä—É—Å—Å–∫|—Ä–æ—Å/iu.test(text)) return "ru";
  if (/–∫–∞–∑–∞–∫|“õ–∞–∑–∞“õ|–∫–∞–∑–∞—Ö/iu.test(text)) return "kz";
  if (/english|–∞–Ω–≥–ª|english please|en\b/iu.test(text)) return "en";
  const hasLatin = /[A-Za-z]/.test(text);
  const hasCyr = /[–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–™—ä–´—ã–≠—ç–ô–π]/.test(text);
  if (hasLatin && !hasCyr) return "en";
  const hasKazChars = /[”ô“ì“õ“£”©“±“Ø“ª—ñ]/i.test(text);
  const hasKazHints = /(—Å–∞–ª–∞–º–∞—Ç|—Å–∞–ª–µ–º|—Ä–∞—Ö–º–µ—Ç|–∂–∞–∫—Å—ã|–±–∞—Ä\s*–º–∞|—Å–µ–Ω–¥–µ—Ä|—Å–∏–∑–¥–µ—Ä|–∏—è\b|–∂–æ–∫\b|“õ–∞–ª–∞–π)/i.test(text);
  if (hasKazChars || hasKazHints) return "kz";
  return null; // –∏–Ω–∞—á–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫
}

// ==== –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã —Å–ª–æ—Ç–æ–≤ ====
function isTimeLike(t) {
  if (!t) return false;
  const s = t.toLowerCase();
  // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
  if (/—á–µ—Ä–µ–∑\s+(–ø–æ–ª|–ø–æ–ª-)?—á–∞—Å–∞?\b/.test(s)) return true;                // —á–µ—Ä–µ–∑ –ø–æ–ª—á–∞—Å–∞ / —á–µ—Ä–µ–∑ —á–∞—Å
  if (/—á–µ—Ä–µ–∑\s+\d+\s*(—á–∞—Å(–∞|–æ–≤)?|–º–∏–Ω(—É—Ç)?)/.test(s)) return true;       // —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ / —á–µ—Ä–µ–∑ 30 –º–∏–Ω
  if (/(now|right now)/.test(s)) return true;
  // —Ä—É—Å/–∫–∞–∑/–∞–Ω–≥ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
  if (/\b(—Å–µ–π—á–∞—Å|–≤–µ—á–µ—Ä|–≤–µ—á–µ—Ä–æ–º|—É—Ç—Ä–æ|—É—Ç—Ä–æ–º|–¥–µ–Ω—å|–¥–Ω–µ–º|—Å–µ–≥–æ–¥–Ω—è|–∑–∞–≤—Ç—Ä–∞|–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞)\b/.test(s)) return true;
  if (/\b(“õ–∞–∑—ñ—Ä|–∫–µ—à–∫–µ|—Ç–∞“£–µ—Ä—Ç–µ“£|—Ç“Ø—Å—Ç–µ|–±“Ø–≥—ñ–Ω|–µ—Ä—Ç–µ“£)\b/.test(s)) return true;
  if (/\b(today|tomorrow|evening|morning|afternoon)\b/.test(s)) return true;
  // —Ñ–æ—Ä–º–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏/–¥–∞—Ç—ã
  if (/\b\d{1,2}[:.]\d{2}\b/.test(s)) return true;            // 11:00 / 19.30
  if (/\b\d{1,2}[/-]\d{1,2}([/-]\d{2,4})?\b/.test(s)) return true; // 29/08 / 29-08-2025
  return false;
  
}function isNameLike(t) {
  if (!t) return false;
  if ((t.match(/\d/g) || []).length > 0) return false;
  const words = t.trim().split(/\s+/);
  return /[A-Za-z–ê-–Ø–∞-—è–Å—ë”ò”ô“í“ì“ö“õ“¢“£”®”©“∞“±“Æ“Ø“∫“ª–Ü—ñ]/.test(t) && words.length <= 3 && t.length <= 40;
}
// >=6 —Ü–∏—Ñ—Ä ‚Äî —Å—á–∏—Ç–∞–µ–º –≤–∞–ª–∏–¥–Ω—ã–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º
function phoneOk(t) {
  return ((t.match(/\d/g) || []).length) >= 6;
}

function hasPhone(t) { return ((t.match(/\d/g) || []).length) >= 6; }
function pickPhone(t) {
  const m = t.match(/[\+\d][\d\-\s().]{5,}/g);
  if (!m) return null;
  // –±–µ—Ä—ë–º —Å–∞–º—É—é –¥–ª–∏–Ω–Ω—É—é ¬´–ø–æ—Ö–æ–∂—É—é –Ω–∞ –Ω–æ–º–µ—Ä¬ª –ø–æ–¥—Å—Ç—Ä–æ–∫—É
  return m.sort((a,b)=> (b.match(/\d/g)||[]).length - (a.match(/\d/g)||[]).length)[0].trim();
}

function guessTopicFrom(userText, lastAssistant = "") {
  const u = (userText || "").toLowerCase();
  const a = (lastAssistant || "").toLowerCase();
  const patterns = [
    { re: /(—Ñ–∏—Ä—Å—Ç–∏–ª|—Ñ–∏—Ä—Å—Ç–∏–ª—å|—Ñ–∏—Ä–º–µ–Ω–Ω(—ã–π|–æ–≥–æ)?\s*—Å—Ç–∏–ª|–±—Ä–µ–Ω–¥(–∏–Ω–≥)?|–ª–æ–≥–æ—Ç–∏–ø|–ª–æ–≥–æ—Ç–∏–ø—ã|–≥–∞–π–¥–ª–∞–π–Ω|brandbook|–±—Ä–µ–Ω–¥–±—É–∫)/,  topic: "–§–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å/–±—Ä–µ–Ω–¥–∏–Ω–≥" },
    { re: /(—Å–∞–π—Ç|–ª–µ–Ω–¥–∏–Ω–≥|landing|web\s*site|–≤–µ–±[-\s]?—Å–∞–π—Ç)/,                                             topic: "–°–∞–π—Ç/–ª–µ–Ω–¥–∏–Ω–≥" },
    { re: /(–∏–∏|—á–∞—Ç.?–±–æ—Ç|ai.?bot|–∂–∞—Å–∞–Ω–¥—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç)/,                                                    topic: "–ò–ò-—á–∞—Ç–±–æ—Ç—ã" },
    { re: /(–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|—Ä–µ–∫–ª–∞–º–∞|—Ç–∞—Ä–≥–µ—Ç|instagram|google\s*ads|smm)/,                                      topic: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥/—Ä–µ–∫–ª–∞–º–∞" },
    { re: /(–±–∏–∑–Ω–µ—Å[-\s]?–ø—Ä–æ—Ü–µ—Å—Å|–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü|crm)/,                                                      topic: "–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã/–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è" },
  ];
  // 1) –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  for (const p of patterns) if (p.re.test(u)) return p.topic;
  // 2) –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî —Å–º–æ—Ç—Ä–∏–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
  for (const p of patterns) if (p.re.test(a)) return p.topic;
  return "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è";
}

// ==== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ—Ä–∞–∑ ====
const L = {
  hi: {
    ru: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ START. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
    kz: "–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! –ú–µ–Ω START –∫–æ–º–ø–∞–Ω–∏—è—Å—ã–Ω—ã“£ –ñ–ò-–∫”©–º–µ–∫—à—ñ—Å—ñ–º—ñ–Ω. “ö–∞–ª–∞–π –∫”©–º–µ–∫—Ç–µ—Å–µ –∞–ª–∞–º—ã–Ω?",
    en: "Hello! I‚Äôm START‚Äôs AI assistant. How can I help?"
  },
  startBooking: {
    ru: "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ –∫–∞–∫–æ–º—É –≤–æ–ø—Ä–æ—Å—É –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ç–∞—Ä–≥–µ—Ç, –ò–ò-–±–æ—Ç, —Å–∞–π—Ç/–≤–æ—Ä–æ–Ω–∫–∞, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è)?",
    kz: "–¢–∞–º–∞—à–∞! “ö–∞–Ω–¥–∞–π —Å“±—Ä–∞“õ –±–æ–π—ã–Ω—à–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è “õ–∞–∂–µ—Ç –µ–∫–µ–Ω—ñ–Ω –Ω–∞“õ—Ç—ã–ª–∞“£—ã–∑ (–º—ã—Å–∞–ª—ã: —Ç–∞—Ä–≥–µ—Ç, –ñ–ò-–±–æ—Ç, —Å–∞–π—Ç/–≤–æ—Ä–æ–Ω–∫–∞, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è)?",
    en: "Great! What topic is the consultation about? (e.g., ads targeting, AI bot, website/funnel, strategy)."
  },
  askWhen: {
    ru: "–ü—Ä–∏–Ω—è—Ç–æ. –ö–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–æ? –ù–∞–ø–∏—à–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≤—Ç—Ä–∞ –≤ 11:00).",
    kz: "–¢“Ø—Å—ñ–Ω–¥—ñ–º. “ö–∞—à–∞–Ω —ã“£“ì–∞–π–ª—ã? –ö“Ø–Ω/—É–∞“õ—ã—Ç—Ç—ã –∂–∞–∑—ã“£—ã–∑ (–º—ã—Å–∞–ª—ã, –µ—Ä—Ç–µ“£ 11:00).",
    en: "Got it. When works for you? Please write date/time (e.g., tomorrow at 11:00)."
  },
  askName: {
    ru: "–û—Ç–ª–∏—á–Ω–æ. –ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?",
    kz: "–ñ–∞“õ—Å—ã. –°—ñ–∑–≥–µ “õ–∞–ª–∞–π –∂“Ø–≥—ñ–Ω–µ–π—ñ–Ω?",
    en: "Great. How should we address you?"
  },
  askPhone: {
    ru: "–°–ø–∞—Å–∏–±–æ. –û—Å—Ç–∞–≤—å—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ WhatsApp.",
    kz: "–†–∞“õ–º–µ—Ç. –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ–º–µ—Å–µ WhatsApp –Ω”©–º—ñ—Ä—ñ“£—ñ–∑–¥—ñ “õ–∞–ª–¥—ã—Ä—ã“£—ã–∑.",
    en: "Thanks. Please share your phone or WhatsApp number."
  },
  confirm: (b, lang) => ({
    ru: `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –∑–∞–ø–∏—Å—å:
‚Äî –¢–µ–º–∞: ${b.topic}
‚Äî –í—Ä–µ–º—è: ${b.when}
‚Äî –ò–º—è: ${b.name}
‚Äî –ö–æ–Ω—Ç–∞–∫—Ç: ${b.phone}
–í—Å–µ –≤–µ—Ä–Ω–æ? –ï—Å–ª–∏ –¥–∞ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–¥–∞¬ª, —è –ø–µ—Ä–µ–¥–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä—É.`,
    kz: `–ñ–∞–∑—ã–ª—É–¥—ã —Ä–∞—Å—Ç–∞–π–º—ã–Ω:
‚Äî –¢–∞“õ—ã—Ä—ã–ø: ${b.topic}
‚Äî –£–∞“õ—ã—Ç—ã: ${b.when}
‚Äî –ï—Å—ñ–º: ${b.name}
‚Äî –ë–∞–π–ª–∞–Ω—ã—Å: ${b.phone}
–î“±—Ä—ã—Å –ø–∞? –ò”ô –±–æ–ª—Å–∞ ‚Äî ¬´–∏”ô¬ª –¥–µ–ø –∂–∞–∑—ã“£—ã–∑, –º–µ–Ω–µ–¥–∂–µ—Ä–≥–µ –±–µ—Ä–µ–º—ñ–Ω.`,
    en: `Confirming your booking:
‚Äî Topic: ${b.topic}
‚Äî Time: ${b.when}
‚Äî Name: ${b.name}
‚Äî Contact: ${b.phone}
Is this correct? If yes, please reply ‚Äúyes‚Äù and I‚Äôll notify a manager.`
  }[lang]),
  booked: {
    ru: "–ü–µ—Ä–µ–¥–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–µ–Ω–µ–¥–∂–µ—Ä—É. –û–Ω —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –°–ø–∞—Å–∏–±–æ!",
    kz: "–ê“õ–ø–∞—Ä–∞—Ç—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–≥–µ –±–µ—Ä–µ–º—ñ–Ω. –û–ª —Ä–∞—Å—Ç–∞—É “Ø—à—ñ–Ω —Å—ñ–∑–±–µ–Ω —Ö–∞–±–∞—Ä–ª–∞—Å–∞–¥—ã. –†–∞“õ–º–µ—Ç!",
    en: "I‚Äôm passing this to a manager. They‚Äôll contact you to confirm. Thank you!"
  },
  resetDone: {
    ru: "–ò—Å—Ç–æ—Ä–∏—è –∏ –∑–∞–ø–∏—Å—å –æ—á–∏—â–µ–Ω—ã. –ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ.",
    kz: "–¢–∞—Ä–∏—Ö –ø–µ–Ω –∂–∞–∑—ã–ª—É —Ç–∞–∑–∞—Ä—Ç—ã–ª–¥—ã. “ö–∞–π—Ç–∞–¥–∞–Ω –±–∞—Å—Ç–∞–π—ã“õ.",
    en: "History and booking cleared. Let‚Äôs start over."
  },
  langSet: (lang) => ({
    ru: `–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${lang}.`,
    kz: `–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç—ñ–ª—ñ –æ—Ä–Ω–∞—Ç—ã–ª–¥—ã: ${lang}.`,
    en: `Interface language set to: ${lang}.`
  }[lang]),
  unknownLang: {
    ru: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏: ru, kz, en. –ü—Ä–∏–º–µ—Ä: /lang ru",
    kz: "“ö–æ–ª–¥–∞—É –∫”©—Ä—Å–µ—Ç—ñ–ª–µ—Ç—ñ–Ω —Ç—ñ–ª–¥–µ—Ä: ru, kz, en. –ú—ã—Å–∞–ª: /lang kz",
    en: "Supported languages: ru, kz, en. Example: /lang en"
  }
};

// ==== –ê–¥—Ä–µ—Å/—Ç–µ–ª–µ—Ñ–æ–Ω/–≥—Ä–∞—Ñ–∏–∫ ‚Äî —Ñ–∏–∫—Å ====
const COMPANY_INFO = {
  address: "–≥. –ê—Å—Ç–∞–Ω–∞, —à–æ—Å—Å–µ –ö–æ—Ä–≥–∞–ª–∂—ã–Ω, 3, –ë–¶ SMART, 4 —ç—Ç–∞–∂, –æ—Ñ–∏—Å 405",
  phone: "+77776662115",
  worktime: "–ü–Ω‚Äì–ü—Ç, 10:00‚Äì18:00",
};

// ==== –ë–∞–∑–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–æ–±—â–∏–π, —è–∑—ã–∫ –ø–æ–¥–º–µ—à–∏–≤–∞–µ–º –Ω–∏–∂–µ) ====
const baseSystemPrompt = `
–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ START (–≥. –ê—Å—Ç–∞–Ω–∞): –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é/—Ä–∞–∑–≤–∏—Ç–∏—é –±–∏–∑–Ω–µ—Å–∞, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, IT-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Å–∞–π—Ç—ã, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ò–ò –∏ –ø—Ä–æ—á–µ–µ, —É–∫–∞–∑–∞–Ω–Ω–æ–µ –Ω–∞ https://strateg.kz/.
–°—Ç–∏–ª—å: –¥–µ–ª–æ–≤–æ–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, 1‚Äì10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã. –ö—Ä–∞—Ç–∫–æ–µ –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ—à—å —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –Ω–∞—à–∏—Ö —É—Å–ª—É–≥ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ.
= –ù–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –Ω–∞—à–∏—Ö —É—Å–ª—É–≥ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞: =
- –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–¥–µ–∏:
-- –†–∞—Å–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π –∫–æ–º–ø–∞–Ω–∏–∏:
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–∏–ª—É—á—à–µ–≥–æ –ø–ª–∞–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞;
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ —É—á—Ç–µ–Ω—ã;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ —Ä—ã–Ω–∫–µ;
--- —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è –±—Ä–µ–Ω–¥–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
- –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑:
-- –ê–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞ —Å —É—á–µ—Ç–æ–º –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤:
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–æ—Å–∞;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–≤—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫;
--- –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ —Ü–µ–Ω;
--- –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥—ã.
- —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑:
-- –í—ã—è–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω—ã –∏–º–µ—é—â–µ–≥–æ—Å—è –±–∏–∑–Ω–µ—Å–∞:
--- —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–±—ã—Ç–∫–æ–≤;
--- –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –ø–æ–Ω—è—Ç–Ω–æ–π –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è —Ñ–æ—Ä–º–µ;
--- –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–π –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–µ–¥–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞.
- —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω:
-- –ü—Ä–æ–≥–Ω–æ–∑ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö:
--- –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥–æ–≤, —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –ø—Ä–∏–±—ã–ª–∏;
--- –ø—Ä–æ–≥–Ω–æ–∑ –¥–≤–∏–∂–µ–Ω–∏—è –¥–µ–Ω–µ–≥;
--- —Ä–∞—Å—á–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π;
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏;
--- –∞–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫ –≤–Ω–µ—à–Ω–∏–º –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Ñ–∞–∫—Ç–æ—Ä–∞–º.
- –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω:
-- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ü–∏—Ñ—Ä–∞—Ö —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∏ —Ä–∏—Å–∫–æ–≤:
--- –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞;
--- –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è;
--- –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å–∞;
--- –æ–±—ä–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏;
--- –∞–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤;
--- —Ä–∞—Å—á–µ—Ç —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏;
--- SWOT-–∞–Ω–∞–ª–∏–∑.
- –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞:
-- –ö—Ä–∞—Ç–∫–∏–π –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π:
--- –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞;
--- –ø–ª–∞–Ω –æ—Å–≤–æ–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π;
--- —Ä–∞—Å—á–µ—Ç —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏;
--- –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞;
--- –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞;
--- –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –ø–ª–∞–Ω;
--- —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø—Ä–æ–≥–Ω–æ–∑;
--- SWOT-–∞–Ω–∞–ª–∏–∑.
- –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π:
-- –°–æ–¥–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞):
--- —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–∑–µ—Ä–∞ –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π;
--- –∑–∞–ø—É—Å–∫ —Ä–µ–∫–ª–∞–º—ã —Å—Ä–µ–¥–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤;
--- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –∫ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∞–º —Å –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º–∏;
--- –ø–æ–º–æ—â—å –≤ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏.
- —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è:
-- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–¥–µ–∏, –º–∏—Å—Å–∏–∏, —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –∫–æ–º–ø–∞–Ω–∏–∏:
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∏—Å—Å–∏–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞;
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ü–µ–ª–µ–π;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π;
--- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–æ–≤;
--- –ø–ª–∞–Ω –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏;
--- —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏;
--- –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π;
--- —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞;
--- –ø–ª–∞–Ω –∏ —Å—Ä–æ–∫–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è.
- –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Ä–∞–±–æ—Ç—ã:
-- –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è:
--- –û—Å–Ω–æ–≤–æ–ø–æ–ª–∞–≥–∞—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:
---- –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ;
---- —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è;
---- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á.
--- –¶–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –∫–æ–º–ø–∞–Ω–∏–∏:
---- –ª–æ–≥–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π;
---- –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è PR-–∞–∫—Ü–∏–π;
---- –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –≤—Å—Ç—Ä–µ—á –∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–π;
---- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏–º–∏–¥–∂–µ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏;
---- –∫–∞–¥—Ä–æ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞;
---- —Ü–µ–Ω–æ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞;
---- —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–Ω–µ–π–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤;
---- —Ç–µ—Ö–Ω–∏–∫–∞ —Ö–æ–ª–æ–¥–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂.
--- –ú–µ–¥–∏–∞-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±—é–¥–∂–µ—Ç:
---- –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π;
---- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ —Ü–µ–ª–µ–≤—ã—Ö –°–ú–ò;
---- –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –ø–ª–∞–Ω.
- –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã:
-- –ê–Ω–∞–ª–∏–∑, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
--- –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–∏—Ö –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤;
--- –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—Ç—ã –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π –∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤;
--- –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º CRM-—Å–∏—Å—Ç–µ–º—ã.
- –ª–æ–≥–æ—Ç–∏–ø –∏ —Å—Ç–∏–ª—å:
-- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ –∏ —Ñ–∏—Ä–º–µ–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–µ–≥–æ –æ–±—Ä–∞–∑ –∫–æ–º–ø–∞–Ω–∏–∏:
--- –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –º–∏—Å—Å–∏–∏ –∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ç—Ä–µ–Ω–¥–∞–º–∏;
--- —Å–º—ã—Å–ª–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Å–∏—Ö–æ–ª–æ–≥–∏–µ–π —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏;
--- —É—á–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞.
- –±—Ä–µ–Ω–¥–±—É–∫:
-- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∏—Ä–º–µ–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è:
--- —Å—Ö–µ–º–∞ –∏ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞;
--- –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ñ–∏—Ä–º–µ–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞ (–∑–Ω–∞–∫, –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —Å–ª–æ–≥–∞–Ω);
--- —Å—Ç–∏–ª—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–µ (–≤–∏–∑–∏—Ç–∫–∏, –±–ª–∞–Ω–∫–∏, –ø–∞–ø–∫–∏ –∏ —Ç.–¥.);
--- –Ω–∞—Ä—É–∂–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ (–≤—ã–≤–µ—Å–∫–∞, –±–∏–ª–±–æ—Ä–¥);
--- –ø–µ—á–∞—Ç–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ (—Ñ–ª–∞–µ—Ä, –±—É–∫–ª–µ—Ç, —Ä–µ–∫–ª–∞–º–Ω—ã–π –ø—Ä–æ—Å–ø–µ–∫—Ç);
--- –≤—ã—Å—Ç–∞–≤–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–Ω–∞–ø–æ–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä, –¥–∏–∑–∞–π–Ω —Å—Ç–µ–Ω–¥–∞);
--- –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –æ—Ñ–∏—Å–∞ (–¥–µ–∫–æ—Ä-—ç–ª–µ–º–µ–Ω—Ç—ã –≤ —Ñ–∏—Ä–º–µ–Ω–Ω–æ–º —Å—Ç–∏–ª–µ);
--- —Å—É–≤–µ–Ω–∏—Ä–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è (—Ä—É—á–∫–∏, –±–ª–æ–∫–Ω–æ—Ç—ã, –∫—Ä—É–∂–∫–∏, –∫–µ–ø–∫–∏, –ø–∞–∫–µ—Ç—ã).
- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞:
-- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥—É–º–∞–Ω–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤:
--- —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã —Å–∞–π—Ç–∞ —Å —É—á–µ—Ç–æ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è;
--- –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–∏–∫–∏ –≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–π –≤–æ—Ä–æ–Ω–∫–∏;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∑–∞–π–Ω–∞ —Å–∞–π—Ç–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ñ–∏—Ä–º–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π;
--- –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ —Å –ø–∞–Ω–µ–ª—å—é –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏;
--- CEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –≤ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞—Ö.
- —Ä–µ–∫–ª–∞–º–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ:
-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∫–ª–∞–º—ã –≤ 2–ì–ò–°, OLX, –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ Google –∏ —Ç–∞—Ä–≥–µ—Ç–∞ –≤ Instagram:
--- —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –≤ 2–ì–ò–°, –≤—ã–±–æ—Ä —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤;
--- —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ OLX, –≤—ã–±–æ—Ä —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ Google;
--- –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–º–µ–¥–∏–π–Ω–æ–π —Å–µ—Ç–∏ (—Ä–µ–∫–ª–∞–º–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö);
--- –∞–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±—é–¥–∂–µ—Ç–∞;
--- –¥–∏–∑–∞–π–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –º–∞–∫–µ—Ç–æ–≤;
--- –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã;
--- —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–æ–≤ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º;
--- –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–µ–∫–ª–∞–º—ã.
- SMM –≤–µ–¥–µ–Ω–∏–µ:
-- –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—á–∫–∏ –≤ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º (—Ä–∞–±–æ—á–µ–π –∏–ª–∏ –ª–∏—á–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞):
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞;
--- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞ –Ω–∞ 1 –º–µ—Å—è—Ü –≤–ø–µ—Ä–µ–¥;
--- –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –≤ Instagram;
--- —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π PR-—Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∏;
--- —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–≤–∏–¥–µ–æ—Å—ä–µ–º–∫–∞ –∏ –¥–∏–∑–∞–π–Ω –º–∞–∫–µ—Ç–æ–≤);
--- —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–ø–æ—Å—Ç—ã, reels, stories);
--- –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.
- –æ—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂:
--- –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–¥–µ–ª–∞ –ø—Ä–æ–¥–∞–∂, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è:
--- –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –≤ –∫–æ–º–ø–∞–Ω–∏–∏;
--- –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ —Å–∞–º–æ–π –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π;
--- –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ö–æ–ª–æ–¥–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂;
--- –æ–±—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –Ω–∞–≤—ã–∫–∞–º —É–¥–µ—Ä–∂–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π;
--- —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–ó–ü, –±–æ–Ω—É—Å—ã, KPI);
--- –æ–±—É—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤–µ–¥–µ–Ω–∏—é –ø—Ä–æ–¥–∞–∂ –≤ CRM-—Å–∏—Å—Ç–µ–º–µ;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∞–ø–æ–≤ –∏ –≤–æ—Ä–æ–Ω–æ–∫ –ø—Ä–æ–¥–∞–∂ –≤ CRM.
- CRM, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –ò–ò:
-- –ü–µ—Ä–µ–≤–æ–¥ –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã –≤ CRM –ë–∏—Ç—Ä–∏–∫—Å24 –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã:
--- —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ crm-—Å–∏—Å—Ç–µ–º–µ –ë–∏—Ç—Ä–∏–∫—Å24;
--- —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–º–ø–∞–Ω–∏–∏;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π;
--- –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SIP-—Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ –∑–∞–ø–∏—Å–∏;
--- –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ WhatsApp, Telegram, Instagram, OLX, —á–∞—Ç –Ω–∞ —Å–∞–π—Ç–µ, —Ñ–æ—Ä–º –∑–∞—è–≤–æ–∫ —Å —Å–∞–π—Ç–∞;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∞–ø–æ–≤ –∏ –≤–æ—Ä–æ–Ω–æ–∫ –ø—Ä–æ–¥–∞–∂, —Å–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö;
--- –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–∑–∞–¥–∞—á–∏, –¥–µ–ª–∞, —Å—Ä–æ–∫–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è);
--- –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∏ –æ–±—É—á–µ–Ω–∏–µ –ò–ò —á–∞—Ç-–±–æ—Ç–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤ 24/7;
--- –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–≤–æ–∑–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ–∫–ª–∞–º—ã.
- —Ñ—Ä–∞–Ω—á–∞–π–∑–∏–Ω–≥:
-- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —É–ø–∞–∫–æ–≤–∫–∞ –≤–æ —Ñ—Ä–∞–Ω—à–∏–∑—É –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –∏–ª–∏ –Ω–æ–≤–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞:
--- —Å–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —Ñ—Ä–∞–Ω—à–∏–∑—ã;
--- –æ–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏;
--- —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è —Ñ—Ä–∞–Ω—à–∏–∑—ã;
--- —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º–æ–¥–µ–ª—å –±–∏–∑–Ω–µ—Å–∞;
--- —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –∏ –¥–æ–≥–æ–≤–æ—Ä—ã;
--- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∞–π—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏;
--- –∑–∞–ø—É—Å–∫ —Ñ—Ä–∞–Ω—à–∏–∑—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π.
= –ö–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥. =
–ü—Ä–∞–≤–∏–ª–∞:
- –£–≤–∞–∂–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞).
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ ‚Äî —Å–æ–±–µ—Ä–∏: {—Ç–µ–º–∞, –≤—Ä–µ–º—è, –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω}. –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∏ –ø–µ—Ä–µ–¥–∞–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ç—ã —É–ø–æ–º—è–Ω—É–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —É—Å–ª—É–≥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∞–π—Ç –∏–ª–∏ –ò–ò-–±–æ—Ç—ã –∏–ª–∏ –ø—Ä.), –Ω–µ —É—Ç–æ—á–Ω—è–π —Ç–µ–º—É –ø–æ–≤—Ç–æ—Ä–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É —É—Å–ª—É–≥—É –∫–∞–∫ topic.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –≤ —á–∞—Ç–µ, –∞ –ø–æ—Å–ª–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª –ø—Ä–æ –¥—Ä—É–≥–∏–µ —É—Å–ª—É–≥–∏ –∏ —Ç–æ–∂–µ –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è, —Ç–æ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –µ–≥–æ –¥–∞–Ω–Ω—ã–µ —Å–Ω–æ–≤–∞, –∞ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–¥–∞–≤–∞–π –∑–∞–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ —Ü–µ–Ω–∞—Ö –∏–ª–∏ —Å—Ä–æ–∫–∞—Ö ‚Äî –≥–æ–≤–æ—Ä–∏, —á—Ç–æ —Ä–∞—Å—á—ë—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ—Å–ª–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏; –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Å—É–º–º—ã –∏ —Å—Ä–æ–∫–∏.
- –ê–¥—Ä–µ—Å –∫–æ–º–ø–∞–Ω–∏–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: ${COMPANY_INFO.address}. –¢–µ–ª–µ—Ñ–æ–Ω: ${COMPANY_INFO.phone}. –†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è: ${COMPANY_INFO.worktime}. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —ç—Ç–æ, –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π.
- –°—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç strateg.kz –¥–∞–≤–∞–π –ø–æ –∑–∞–ø—Ä–æ—Å—É –∏–ª–∏ –µ—Å–ª–∏ –ª–æ–≥–∏—á–Ω–æ –ø–æ —Ö–æ–¥—É –±–µ—Å–µ–¥—ã. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —É—Å–ª—É–≥ —á–µ—Ä–ø–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –æ—Ç—Ç—É–¥–∞.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –≤–Ω–µ —Ç–µ–º –±–∏–∑–Ω–µ—Å–∞ START ‚Äî –æ—Ç–≤–µ—Ç—å –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç.
`;

// ==== –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–∞ ====
export default async function handler(req, res) {
  try {
    if (req.method !== "POST") {
      res.statusCode = 405;
      return res.end("Method Not Allowed");
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–∞ Telegram
    const headerSecret = req.headers["x-telegram-bot-api-secret-token"];
    if (!headerSecret || headerSecret !== process.env.TELEGRAM_SECRET_TOKEN) {
      res.statusCode = 401;
      return res.end("Unauthorized");
    }

    // –ü–∞—Ä—Å–∏–º –∞–ø–¥–µ–π—Ç
    const raw = await readBody(req);
    const update = raw ? JSON.parse(raw) : {};
    const message = update.message || update.edited_message || null;

    // –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
    if (!message || !message.text) {
      res.statusCode = 200;
      return res.end(JSON.stringify({ ok: true }));
    }

    const chatId = message.chat.id;
    const userText = (message.text || "").trim();

    // ===== –Ø–∑—ã–∫: –∞–≤—Ç–æ-–¥–µ—Ç–µ–∫—Ç + —Ä—É—á–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ =====
    // 1) /lang <code>
    if (/^\/lang\b/i.test(userText)) {
      const parts = userText.split(/\s+/);
      const code = (parts[1] || "").toLowerCase();
      if (code === "ru" || code === "kz" || code === "en") {
        await redis.set(LANG_KEY(chatId), code, { ex: 60 * 60 * 24 * 30 });
        const msg = L.langSet(code);
        await sendTG(chatId, msg);
        res.statusCode = 200;
        return res.end(JSON.stringify({ ok: true }));
      } else {
        const current = (await redis.get(LANG_KEY(chatId))) || detectLang(userText) || "ru";
        await sendTG(chatId, L.unknownLang[current] || L.unknownLang.ru);
        res.statusCode = 200;
        return res.end(JSON.stringify({ ok: true }));
      }
    }

    // 2) /reset ‚Äî –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏/—Å–ª–æ—Ç–æ–≤
    if (userText === "/reset") {
      await redis.del(`hist:${chatId}`);
      await redis.del(`book:${chatId}`);
      await clearContact(chatId); // <‚Äî –î–û–ë–ê–í–ò–õ–ò
      const current = (await redis.get(LANG_KEY(chatId))) || detectLang(userText) || "ru";
      await sendTG(chatId, L.resetDone[current] || L.resetDone.ru);
      res.statusCode = 200;
      return res.end(JSON.stringify({ ok: true }));
    }

    // 3) –í—ã—á–∏—Å–ª—è–µ–º —è–∑—ã–∫: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ; –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ–º —Å–∏–≥–Ω–∞–ª–µ
    const stored = await redis.get(LANG_KEY(chatId));
    const guess = confidentLangSwitch(userText);
    let lang = (stored || guess || "ru");
    if (!stored || (guess && guess !== stored)) {
      await redis.set(LANG_KEY(chatId), lang, { ex: 60 * 60 * 24 * 30 });
    }

    if (userText === "/whoami") {
      await sendTG(chatId, `chat.id: ${chatId}`);
      res.statusCode = 200;
      return res.end(JSON.stringify({ ok: true }));
    }

    if (userText === "/pingadmin") {
      const adminId = getAdminId();
      if (!adminId) {
        await sendTG(chatId, "ADMIN_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω");
      } else {
        await sendTG(adminId, "‚úÖ –¢–µ—Å—Ç: —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏–∑ –±–æ—Ç–∞");
        await sendTG(chatId, `–û—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ—Å—Ç –∞–¥–º–∏–Ω—É: ${adminId}`);
      }
      res.statusCode = 200;
      return res.end(JSON.stringify({ ok: true }));
    }

    // ==== –ü—Ä–æ—Ñ–∏–ª—å –∫–æ–Ω—Ç–∞–∫—Ç–∞ (–∫—ç—à–∏—Ä—É–µ–º –∏–º—è/—Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞ 30 –¥–Ω–µ–π) ====
    async function getContact(chatId) {
      const v = await redis.get(`contact:${chatId}`);
      if (!v) return null;
      try { return typeof v === "string" ? JSON.parse(v) : v; } catch { return null; }
    }
    async function setContact(chatId, { name, phone }) {
      await redis.set(`contact:${chatId}`, JSON.stringify({ name, phone }), { ex: 60 * 60 * 24 * 30 });
    }
    async function clearContact(chatId) {
      await redis.del(`contact:${chatId}`);
    }
    
    // ===== –°–ª–æ—Ç—ã –∑–∞–ø–∏—Å–∏ =====
const booking = await getBooking(chatId);
let handled = false;
let preReply = null;

// === REUSE CONTACT: –µ—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç —É–∂–µ –µ—Å—Ç—å, –∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –ø—Ä–æ –Ω–æ–≤—É—é —É—Å–ª—É–≥—É ‚Äî —à–ª—ë–º –ª–∏–¥ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
const contact = await getContact(chatId);
if (!booking.stage && contact?.phone && !hasPhone(userText)) {
  // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Ç–µ–º—ã —Ç–æ–ª—å–∫–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –ª–∏–¥, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å
  const hist  = await getHistory(chatId);
  const lastA = hist.filter(h => h.role === "assistant").slice(-1)[0];
  const topicFromMsg = guessTopicFrom(userText, ""); // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ userText
  if (topicFromMsg && topicFromMsg !== "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è") {
    const when = isTimeLike(userText) ? userText : "-";

    // 1) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ‚Äî –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç
    preReply = L.booked[lang] || L.booked.en;

    // 2) –ê–¥–º–∏–Ω—É ‚Äî –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –ø–æ –Ω–æ–≤–æ–π —Ç–µ–º–µ
    const adminId = getAdminId();
    if (adminId) {
      const adminMsg =
        `üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —á–∞—Ç–±–æ—Ç–∞:\n` +
        `–¢–µ–º–∞: ${topicFromMsg}\n` +
        `–í—Ä–µ–º—è: ${when}\n` +
        `–ò–º—è: ${contact.name || "-"}\n` +
        `–¢–µ–ª–µ—Ñ–æ–Ω: ${contact.phone || "-"}\n` +
        `–ò—Å—Ç–æ—á–Ω–∏–∫: tg chat_id ${chatId}`;
      const r = await sendTG(adminId, adminMsg);
      if (!r.ok) console.error("Failed to send reused-contact lead to admin:", adminId);
    } else {
      console.error("ADMIN_CHAT_ID is not set or empty");
    }

    handled = true;
  }
}
    
const bookTrigger = /–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü|–∑–∞–ø–∏—Å|–º–µ–Ω–µ–¥–∂–µ—Ä|–ø–æ–≥–æ–≤–æ—Ä|“õ–∞–±—ã–ª–¥–∞|–∫–µ“£–µ—Å|consult|booking/i;

// ONE-SHOT: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –ø—Ä–∏—Å–ª–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω (–∏ —Ç–µ–∫—Å—Ç), —Å–æ–∑–¥–∞—ë–º –ª–∏–¥ –±–µ–∑ –∑–∞–ø—É—Å–∫–∞ —Å–ª–æ—Ç–æ–≤
if (!booking.stage && hasPhone(userText)) {
  const phone  = pickPhone(userText);
  const hist   = await getHistory(chatId);
  const lastA  = hist.filter(h => h.role === "assistant").slice(-1)[0];

  // —Ç–µ–º–∞ ‚Äî –ø–æ —Ç–µ–∫—Å—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ fallback –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –æ—Ç–≤–µ—Ç—É
  const topic  = guessTopicFrom(userText, lastA?.content || "");

  // –≤—Ä–µ–º—è: –µ—Å–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ ‚Äî –±–µ—Ä—ë–º –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è; –∏–Ω–∞—á–µ "-"
  const when   = isTimeLike(userText) ? userText : "-";

  // –∏–º—è: –¥–æ –ø–µ—Ä–≤–æ–π –∑–∞–ø—è—Ç–æ–π / —Å–ª–æ–≤–∞ "—Ç–µ–ª"/"phone"; –±–µ–∑ —Ü–∏—Ñ—Ä
  let nameCandidate = userText.split(/[,;]|—Ç–µ–ª(–µ—Ñ–æ–Ω)?|phone/i)[0].trim();
  const name  = isNameLike(nameCandidate) ? nameCandidate : "-";

  // 1) —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  preReply = L.booked[lang] || L.booked.en;

  // 2) –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥–º–∏–Ω—É
  const adminId = getAdminId();
  if (adminId) {
    const adminMsg =
      `üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —á–∞—Ç–±–æ—Ç–∞:\n` +
      `–¢–µ–º–∞: ${topic}\n` +
      `–í—Ä–µ–º—è: ${when}\n` +
      `–ò–º—è: ${name}\n` +
      `–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n` +
      `–ò—Å—Ç–æ—á–Ω–∏–∫: tg chat_id ${chatId}`;
    const r = await sendTG(adminId, adminMsg);
    if (!r.ok) console.error("Failed to send one-shot lead to admin:", adminId);
  } else {
    console.error("ADMIN_CHAT_ID is not set or empty");
  }

  await setContact(chatId, { name, phone }); // <‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
  
  await clearBooking(chatId);
  handled = true;
}
    // –æ–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–ª–æ—Ç–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
else if (!booking.stage && bookTrigger.test(userText)) {
  // ... (—Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π –∫–æ–¥ –∞–≤—Ç–æ–ø–æ–¥—Ö–≤–∞—Ç–∞ —Ç–µ–º—ã –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ when)  
  // –ü–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å —Ç–µ–º—É –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
      const hist = await getHistory(chatId);
      const lastA = hist.filter(h => h.role === "assistant").slice(-1)[0];
      let autoTopic = null;

      if (lastA && typeof lastA.content === "string") {
        const txt = lastA.content.toLowerCase();
        if (/–∏–∏|—á–∞—Ç.?–±–æ—Ç|ai.?bot|–∂–∞—Å–∞–Ω–¥—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç/i.test(txt)) autoTopic = "–ò–ò-—á–∞—Ç–±–æ—Ç—ã";
        else if (/—Å–∞–π—Ç|–ª–µ–Ω–¥–∏–Ω–≥|landing|web\s*site/i.test(txt)) autoTopic = "–°–∞–π—Ç/–ª–µ–Ω–¥–∏–Ω–≥";
        else if (/–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|—Ä–µ–∫–ª–∞–º–∞|—Ç–∞—Ä–≥–µ—Ç|instagram|google\s*ads/i.test(txt)) autoTopic = "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥/—Ä–µ–∫–ª–∞–º–∞";
        else if (/–±–∏–∑–Ω–µ—Å[-\s]?–ø—Ä–æ—Ü–µ—Å—Å|–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü/i.test(txt)) autoTopic = "–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã/–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è";
      }

      if (autoTopic) {
        booking.topic = autoTopic;
        booking.stage = "when";
        await setBooking(chatId, booking);
        preReply = L.askWhen[lang] || L.askWhen.en;
      } else {
        booking.stage = "topic";
        await setBooking(chatId, booking);
        preReply = L.startBooking[lang] || L.startBooking.en;
      }
      handled = true;
    }
    else if (booking.stage === "topic" && userText.length > 1) {
      booking.topic = userText;
      booking.stage = "when";
      await setBooking(chatId, booking);
      preReply = L.askWhen[lang] || L.askWhen.en;
      handled = true;
    }
    else if (booking.stage === "when") {
      if (isTimeLike(userText)) {
        booking.when = userText;
        booking.stage = "name";
        await setBooking(chatId, booking);
        preReply = L.askName[lang] || L.askName.en;
      } else {
        preReply = L.askWhen[lang] || L.askWhen.en; // –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ
      }
      handled = true;
    }
    else if (booking.stage === "name") {
      if (isNameLike(userText)) {
        booking.name = userText;
        booking.stage = "phone";
        await setBooking(chatId, booking);
        preReply = L.askPhone[lang] || L.askPhone.en;
      } else {
        preReply = (lang === "kz")
          ? "–ï—Å—ñ–º —Ç–µ–∫ –º”ô—Ç—ñ–Ω —Ç“Ø—Ä—ñ–Ω–¥–µ –∫–µ—Ä–µ–∫ (—Ü–∏—Ñ—Ä–ª–∞—Ä—Å—ã–∑). “ö–∞–ª–∞–π –∂–∞–∑—ã–ª–∞–¥—ã?"
          : (lang === "en")
            ? "Please send just your name (letters only)."
            : "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∏–º—è (–±–µ–∑ —Ü–∏—Ñ—Ä). –ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?";
      }
      handled = true;
    }
    else if (booking.stage === "phone") {
      if (phoneOk(userText)) {
        booking.phone = userText;

        // 1) –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        preReply = L.booked[lang] || L.booked.en;

        // 2) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
        const adminId = getAdminId();
        if (adminId) {
          const adminMsg =
            `üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —á–∞—Ç–±–æ—Ç–∞:\n` +
            `–¢–µ–º–∞: ${booking.topic || "-"}\n` +
            `–í—Ä–µ–º—è: ${booking.when || "-"}\n` +
            `–ò–º—è: ${booking.name || "-"}\n` +
            `–¢–µ–ª–µ—Ñ–æ–Ω: ${booking.phone || "-"}\n` +
            `–ò—Å—Ç–æ—á–Ω–∏–∫: tg chat_id ${chatId}`;
          const r = await sendTG(adminId, adminMsg);
          if (!r.ok) console.error("Failed to send lead to admin:", adminId);
        } else {
          console.error("ADMIN_CHAT_ID is not set or empty");
        }

        await setContact(chatId, { name: booking.name, phone: booking.phone }); // <‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
        
        await clearBooking(chatId);
      } else {
        preReply = (lang === "kz")
          ? "–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω –∂—ñ–±–µ—Ä—ñ“£—ñ–∑ (–∫–µ–º—ñ–Ω–¥–µ 11 —Ü–∏—Ñ—Ä)."
          : (lang === "en")
            ? "Please send a phone number (at least 11 digits)."
            : "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–µ –º–µ–Ω–µ–µ 11 —Ü–∏—Ñ—Ä).";
      }
      handled = true;
    }

    if (handled && preReply) {
      await pushHistory(chatId, "user", userText);
      await pushHistory(chatId, "assistant", preReply);
      await sendTG(chatId, preReply);
      res.statusCode = 200;
      return res.end(JSON.stringify({ ok: true }));
    }

    // ===== –û–±—ã—á–Ω—ã–π –ò–ò-–æ—Ç–≤–µ—Ç —Å –∏—Å—Ç–æ—Ä–∏–µ–π, –Ω–∞ –Ω—É–∂–Ω–æ–º —è–∑—ã–∫–µ =====
    const history = await getHistory(chatId);
    const languageLine = lang === "ru"
      ? "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
      : lang === "kz"
      ? "–ñ–∞—É–∞–ø—Ç—ã “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ –±–µ—Ä."
      : "Reply in English.";

    const systemPrompt = baseSystemPrompt + "\n" + languageLine;

    const maybeHi = history.length === 0 ? (L.hi[lang] || L.hi.ru) : null;

    const messages = [
      { role: "system", content: systemPrompt },
      ...history,
      { role: "user", content: userText },
    ];

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages,
      temperature: 0.2,
    });

    let reply =
      completion.choices?.[0]?.message?.content?.slice(0, 3500) ||
      (maybeHi || "–ì–æ—Ç–æ–≤–æ. –ö–∞–∫–æ–π —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å?");

    if (history.length === 0 && (!reply || reply.trim().length < 3)) {
      reply = maybeHi;
    }

    await pushHistory(chatId, "user", userText);
    await pushHistory(chatId, "assistant", reply);
    await sendTG(chatId, reply);

    res.statusCode = 200;
    res.end(JSON.stringify({ ok: true }));
  } catch (err) {
    console.error(err);
    res.statusCode = 500;
    res.end("Internal Error");
  }
}

// ==== –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram ====
function getAdminId() {
  const raw = (process.env.ADMIN_CHAT_ID || "").trim().replace(/^['"]|['"]$/g, "");
  return raw;
}

async function sendTG(chatId, text) {
  const resp = await fetch(
    `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: chatId, text }),
    }
  );
  if (!resp.ok) {
    const body = await resp.text();
    console.error("sendTG error", resp.status, body, "chat_id=", chatId);
  }
  return resp;
}
